

Examining Code Reuse Reveals
Undiscovered Links Among North
Korea’s Malware Families

Newsletter Sign Up

By Jay Rosenberg and Christiaan Beek on Aug 09, 2018

Last Name *

This research is a joint effort by Jay Rosenberg, senior security researcher at Intezer, and
PDFmyURL - online url to pdf conversion

First Name *

Christiaan Beek, lead scientist and senior principal engineer at McAfee. Intezer has also posted

Email Address *

this story.
Attacks from the online groups Lazarus, Silent Chollima, Group 123, Hidden Cobra,
DarkSeoul, Blockbuster, Operation Troy, and 10 Days of Rain are believed to have come
from North Korea. But how can we know with certainty? And what connection does a
DDoS and disk-wiping attack from July 4, 2009, have with WannaCry, one of the largest
cyberattacks in the history of the cyber sphere?
From the Mydoom variant Brambul to the more recent Fallchill, WannaCry, and the
targeting of cryptocurrency exchanges, we see a distinct timeline of attacks beginning
from the moment North Korea entered the world stage as a significant threat actor.

Country *
--Please Select-Submit

McAfee on Twitter
 Follow us on Twitter

Bad actors have a tendency to unwittingly leave fingerprints on their attacks, allowing
researchers to connect the dots between them. North Korean actors have left many of
these clues in their wake and throughout the evolution of their malware arsenal.
This post reflects months of research; in it we will highlight our code analysis illustrating
key similarities between samples attributed to the Democratic People’s Republic of
Korea, a shared networking infrastructure, and other revealing data hidden within the
binaries. Together these puzzle pieces show the connections between the many attacks
attributed to North Korea and categorize different tools used by specific teams of their
cyber army.

mcafee_labs
Threat actors continue to evolve
their tools, increasing complexity
and functionality. Learn how
these cybercrimes…
https://t.co/ibrUsYyn7V
21 hours ago
Reply · Retweet · Favorite

Valuable context
This article is too short to dig deeply into the history, politics, and economic changes of
recent years. Nonetheless, we must highlight some events to put past and present cyber
events into perspective.

PDFmyURL - online url to pdf conversion

mcafee_labs
ICYMI: Our team analyzed
Operation GhostSecret, a Hidden

The DPRK, like any country, wants to be as self-sufficient and independent as possible.
However, for products such as oil, food, and foreign currency for trading, the country

Cobra campaign that leveraged
multiple #malware implants i…

lacks resources and has to find ways of acquiring them. What can a nation do when legal
international economics are denied? To survive, it must gain foreign currency for trading.
One of the oldest ways to do this is to join the worlds of gambling (casinos) and drugs. In

https://t.co/FLgQ6Vn4yc

2005, the United States wanted to shut down North Korean enterprises involved in illegal
operations. They investigated a couple of banks in Asia that seemed to have ties with
North Korea and operated as money laundering sites. One bank in particular is
controlled by a billionaire gambling mogul who started a casino in Pyongyang and has
close ties to Pyongyang. That bank, based in Macau, came back into the picture during an
attack on the SWIFT financial system of a bank in Vietnam in 2015. The Macau bank was
listed twice in the malware’s code as a recipient of stolen funds:

22 hours ago
Reply · Retweet · Favorite

mcafee_labs
Bad actors are exploiting
connected home devices to find
new innocent targets. Which
connected device do you think…
https://t.co/pxWq9B6Rqo
2 days ago
Reply · Retweet · Favorite

Next Article

PDFmyURL - online url to pdf conversion

Consumer Threat Notices

5 Tips To Protect Your IoT Devices

Figure 1: SWIFT code in malware.
Code reuse
PDFmyURL - online url to pdf conversion

There are many reasons to reuse malware code, which is very common in the world of
cybercrime. If we take an average ransomware campaign, for example, once the
campaign becomes less successful, actors often change some of basics such as using a
different packer to bypass defenses. With targeted campaigns, an adversary must keep
its tools undetected for as long as possible. By identifying reused code, we gain valuable
insights about the “ancestral relations” to known threat actors or other campaigns. Our
research was heavily focused on this type of analysis.
In our years of investigating cyber threats, we have seen the DPRK conduct multiple
cyber campaigns. In North Korea, hackers’ skills determine which cyber units they work
for. We are aware two major focuses of DPRK campaigns: one to raise money, and one to
pursue nationalist aims. The first workforce gathers money for the nation, even if that
means committing cybercrime to hack into financial institutions, hijack gambling
sessions, or sell pirated and cracked software. Unit 180 is responsible for illegally gaining
foreign currency using hacking techniques. The second workforce operates larger
campaigns motivated by nationalism, gathering intelligence from other nations, and in
some cases disrupting rival states and military targets. Most of these actions are
executed by Unit 121.
We focused in our research on the larger-scale nationalism-motivated campaigns, in
which we discovered many overlaps in code reuse. We are highly confident that nationstate–sponsored groups were active in these efforts.
Timeline
We created a timeline of most of the malware samples and noticeable campaigns that we
examined. We used primarily open-source blogs and papers to build this timeline and
used the malware artifacts as a starting point of our research.

PDFmyURL - online url to pdf conversion

Figure 2: Timeline of malware and campaigns.
Analysis and observations
Similarities
During our research, we found many malware family names that are believed to be
associated with North Korea’s cyber operations. To better understand this threat actor
and the similarities between the campaigns, we have used Intezer’s code similarity
detection engine to plot the links between a vast number of these malware families.
The following graph presents a high-level overview of these relations. Each node
PDFmyURL - online url to pdf conversion

represents a malware family or a hacking tool (“Brambul,” “Fallchill,” etc.) and each line
presents a code similarity between two families. A thicker line correlates to a stronger
similarity. In defining similarities, we take into account only unique code connections, and
disregard common code or libraries. This definition holds both for this graph and our
entire research.

PDFmyURL - online url to pdf conversion

Figure 3: Code similarities between North Korean–associated malware families.
PDFmyURL - online url to pdf conversion

We can easily see a significant amount of code similarities between almost every one of
the attacks associated with North Korea. Our research included thousands of samples,
mostly unclassified or uncategorized. This graph was plotted using a data set of only
several hundred samples, so there might be more connections than displayed here.
Deep technical analysis
During our research, we came across many code similarities between North Korean
binaries that had not been seen before. Some of these attacks and malware have not
been linked to one another, at least publicly. We will showcase four examples of reused
code that has been seen only in malware attributed to North Korea.
1. Common SMB module
The first code example appeared in the server message block (SMB) module of WannaCry
in 2017, Mydoom in 2009, Joanap, and DeltaAlfa. Further shared code across these
families is an AES library from CodeProject. These attacks have been attributed to
Lazarus; that means the group has reused code from at least 2009 to 2017.

PDFmyURL - online url to pdf conversion

Figure 4: Code overlap of a Mydoom sample.
In the next screenshots we highlight the exact code block that reflects the SMB module
we found in campaigns other than WannaCry and Mydoom.

PDFmyURL - online url to pdf conversion

PDFmyURL - online url to pdf conversion

Figure 5: An SMB module common to several attacks.
A lot has been written about WannaCry. As we analyze the code against our databases,
we can draw the following overview:

PDFmyURL - online url to pdf conversion

Figure 6: WannaCry code comparison overview.
For our research we compared the three major variants of WannaCry. An early release,
called a beta, from February 2017, one from April, and the infamous one that hit the
world in May.
2. Common file mapping
The second example demonstrates code responsible for mapping a file and using the
XOR key 0xDEADBEEF on the first four bytes of the file. This code has appeared in the
PDFmyURL - online url to pdf conversion

malware families NavRAT and Gold Dragon, plus a certain DLL from the South Korean
gambling hacking campaign. These three RATs are thought to be affiliated with North
Korea’s Group 123. NavRAT and the gambling DLL share more code, making them closer
variants.

Figure 7: Code overlap in a NavRAT sample.

PDFmyURL - online url to pdf conversion

PDFmyURL - online url to pdf conversion

Figure 8: File-mapping code
3. Unique net share
The third example, responsible for launching a cmd.exe with a net share, has been seen
in 2009’s Brambul, also known as SierraBravo, as well as KorDllBot in 2011. These
malware families are also attributed to the Lazarus group.

Figure 9: Code overlap of a SierraBravo (Brambul) sample.

PDFmyURL - online url to pdf conversion

PDFmyURL - online url to pdf conversion

Figure 10: A code block reused in the malware families Brambul/SierraBravo and KorDllBot.
4. Operation Dark Hotel
In 2014, Kaspersky reported a more than seven-year campaign against Asian hotels, in
which the adversaries used an arsenal of tools to break into the computers of hotel
visitors. Zero days and control servers were used, along with the malware family
Tapaoux, or DarkHotel, according to the report.
While we examined the DPRK samples, we noticed a hit with the Dark Hotel samples in
our collections. By going through the code, we noticed several pieces of code overlap and
reuse, for example, with samples from Operation Troy.

PDFmyURL - online url to pdf conversion

Figure 11: Code overlap in a Dark Hotel sample.
Identifying a group
By applying what we learned from our comparisons and code-block identifications, we
uncovered possible new links between malware families and the groups using them.
With the different pieces of malware we have analyzed, we can illustrate the code reuse
and sharing between the groups known to be affiliated with North Korea.

PDFmyURL - online url to pdf conversion

Figure 12: Groups and families linked by code reuse.
PDFmyURL - online url to pdf conversion

The malware attributed to the group Lazarus has code connections that link many of the
malware families spotted over the years. Lazarus is a collective name for many DPRK
cyber operations, and we clearly see links between malware families used in different
campaigns.
The malware (NavRAT, gambling, and Gold Dragon) possibly created by Group 123 are
connected to each other but are separate from those used by Lazarus. Although these
are different units focusing on different areas, there seems to be a parallel structure in
which they collaborate during certain campaigns.
MITRE ATT&CK
From our research of these malware samples, we can identify the following techniques
used by the malware families:

When we zoom in on the Discovery category in the MITRE model, for example, we notice
that the techniques are typical for first-stage dropper malware. The adversary drops
PDFmyURL - online url to pdf conversion

these samples on victims’ machines and collects information on where they landed in the
victims’ networks and which user/access rights they gained.
In 2018, we saw examples of campaigns in which attackers used PowerShell to download
and execute these droppers. Once information has been sent to a control server, the
adversary determines the next steps, which often include installing a remote access tool
to enable lateral movement on the network and pursue the goals of the campaign.
Final words
Security vendors and researchers often use different names when speaking about the
same malware, group, or attack. This habit makes it challenging to group all the malware
and campaigns. By taking a scientific approach, such as looking for code reuse, we can
categorize our findings. We believe our research will help the security community
organize the current “mess” we face in relation to North Korean malware and campaigns.
We clearly saw a lot of code reuse over the many years of cyber campaigns we examined.
This indicates the North Koreans have groups with different skills and tools that execute
their focused parts of cyber operations while also working in parallel when large
campaigns require a mix of skills and tools.
We found our months of research, data gathering, and analysis very satisfying. By
combining our skills, data, and technology, we were able to draw connections and reveal
links that we had not seen before. The cybersecurity industry would greatly benefit from
more collaboration and sharing of information, and we hope that this effort between
McAfee and Intezer will inspire the community to work together more often.
The authors thank Costin Raiu for providing them with samples they did not have in their
collections.

PDFmyURL - online url to pdf conversion

Sources
Glenn Simpson, Gordon Fairclough, and Jay Solomon, “U.S. Probes Banks’ North Korea
Ties.” Wall Street Journal, last updated September 8, 2005.
Christiaan Beek, “Attacks on SWIFT Banking system benefit from insider knowledge.”
https://securingtomorrow.mcafee.com/mcafee-labs/attacks-swift-banking-systembenefit-insider-knowledge/
Atif Mushtaq, “DDOS Madness Continued…” https://www.fireeye.com/blog/threatresearch/2009/07/ddos-madness-climax.html
Ryan Sherstobitoff and Jessica Saavedra-Morales, “Gold Dragon Widens Olympics
Malware Attacks, Gains Permanent Presence on Victims’ Systems.”
https://securingtomorrow.mcafee.com/mcafee-labs/gold-dragon-widens-olympicsmalware-attacks-gains-permanent-presence-on-victims-systems/
Alex Drozhzhin, “Darkhotel: a spy campaign in luxury Asian hotels.”
https://www.kaspersky.com/blog/darkhotel-apt/6613/
Warren Mercer, Paul Rascagneres, and Jungsoo An, “NavRAT Uses US-North Korea
Summit As Decoy For Attacks In South Korea.”
https://blog.talosintelligence.com/2018/05/navrat.html
Sergei Shevchenko and Adrian Nish, “Cyber Heist Attribution.”
https://baesystemsai.blogspot.com/2016/05/cyber-heist-attribution.html
Mydoom code reuse report. https://analyze.intezer.com/#/analyses/113ba80f-1680-43d7b287-cc62f3740fad

PDFmyURL - online url to pdf conversion

NavRAT code reuse report. https://analyze.intezer.com/#/analyses/4f19fd5a-a898-4fdf96c9-d3a4aad817cb
SierraBravo code reuse report. https://analyze.intezer.com/#/analyses/8da8104e-56e449fd-ba24-82978bc1610c
Dark Hotel code reuse report. https://analyze.intezer.com/#/analyses/c034e0fe-78254f6d-b092-7c5ee693aff4
Kang Jang-ho, “A foreign currency earned with a virtual currency … What is the life of a
North Korean hacker?” http://m.mtn.co.kr/news/news_view.php?
mmn_idx=2018062517065863930#_enliple
Awesome work by the team responsible for the “Operation Blockbuster”
report. https://www.operationblockbuster.com/resources/

 Previous Article

Next Article 

 Categories: McAfee Labs
 Tags: advanced persistent threats, Advanced Threat Research, cybersecurity, hacking

Leave a reply
Facebook Comments (0) Comments (0) G+ Comments
PDFmyURL - online url to pdf conversion

0 Comments

Sort by Oldest

Add a comment...

Facebook Comments Plugin

Leave a Comment
Comment

Name *

Email *

Please enter an answer in digits:
5×3=
Post Comment

About | Subscribe | Contact & Media Requests | Privacy Policy | Legal
© 2018 McAfee LLC
PDFmyURL - online url to pdf conversion











Close Menu
Search



Back

Business
Consumer
Executive Perspectives
McAfee Partners
McAfee Labs
Languages
English

Follow us










About
Subscribe
Contact & Media Requests
Privacy Policy
Legal

© McAfee LLC

PDFmyURL - online url to pdf conversion

