Attack infrastructure analysis - June 2019

Iranian APT group ‘MuddyWater’ Adds Exploits to Their Arsenal
Overview and Analysis of MuddyWater New Infrastructures and TTPs

June 2019

June 2019

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 1 of 17

Attack infrastructure analysis - June 2019

Table of Contents
Executive Summary
Attack Vector 1 – malicious macro
Attack Vector 2 – CVE-2017-0199
Malware analysis – RAT
The combained attack vector
The contents of the documents
Indicators of Compromise

3
4
5
10
12
13
16

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 2 of 17

Attack infrastructure analysis - June 2019
Executive Summary
In recent months, there has been considerable unrest in the Iranian cyber sphere. Highly sensitive data about
Iranian APT groups was leaked, exposing abilities, strategies, and attack tools. The main medium for this leak was
a telegram channel.
The first leak uncovered attack frameworks and webshells of APT-341 (Known as OilRig group). This was followed
by another leak that that exposed previously unknown details (such as compromised C2 servers) regarding the
operation of MuddyWater2. Further, it detailed the modus operandi of RANA - a cyber division of the Iranian
Ministry of Intelligence (MOIS).
However, Clearsky’s Threat Intelligence team investigation indicate that MuddyWater's activities were
unaffected. This report will reveal the group's latest exploit usage and TTPs.
Clearsky has detected new and advanced attack vector used by MuddyWater to target governmental entities and
the telecommunication sector. Notably, the TTP includes decoy documents exploiting CVE-2017-0199 as the first
stage of the attack. This is followed by the second stage of the attack – communication with the hacked C2 servers
and downloading a file infected with the macros.
MuddyWater (aka SeedWorm/Temp.Zagros) is a high-profile Advanced Persistent Threat (APT) actor sponsored
by Iran. The group was first observed in 2017, and since has operated multiple global espionage campaigns. With
that in mind, their most significant operations mainly focus on Middle Eastern and Middle Asian nations3.
The group targets a wide gamut of sectors, including governmental, military, telecommunication, and academia.
In the past months, Clearsky had monitored and detected malicious files of each one of these TTPs - decoy
Microsoft software with embedded Macros4; and documents exploiting vulnerability CVE-2017-01995. This is the
first time MuddyWater has used these two vectors in conjunction.
By analyzing the Rana documents 6 , it appears that
the MOIS attack teams are divided in to two
branches, each with different purposes.
The first is the espionage team that specialize with
hacking systems, while the other is the social
engineering team that compromises assets via social
engineering and spear-phishing methods. Clearsky
assessment is that MuddyWater is likely the latter
group.

1

https://www.bleepingcomputer.com/news/security/hacker-group-exposes-iranian-apt-operations-and-members/

2

https://www.zdnet.com/article/new-leaks-of-iranian-cyber-espionage-operations-hit-telegram-and-the-dark-web/

3 https://unit42.paloaltonetworks.com/unit42-muddying-the-water-targeted-attacks-in-the-middle-east/
4 https://www.clearskysec.com/muddywater-targets-kurdish-groups-turkish-orgs/
5 https://twitter.com/ClearskySec/status/1118511605359304705

6

https://www.clearskysec.com/iranian-apt-black-box/
© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 3 of 17

Attack infrastructure analysis - June 2019
Attack Vector 1 – malicious macro
It appears that in the recent campaign, the group returned to use (in certain cases) compromised servers. They
leveraged the servers to host malicious code segment used in the second stage of the attacks; similar to previous
operations. Concurrently we identified several files by MuddyWater that targeted various entities in Tajikistan
while using the group's classic attack vector – a malicious VBA macro.
We were notified about one of the files by a colleague of us7. This file, named 'UNDP_TJK_Agreement_ORGS.doc',
was disguised as an official document of a UN development plan in Tajikistan.

After opening the document, a VBS file is created. It is encoded with multiple VBE, JavaScript, and Base64 layers;
similar to previous attack vectors by MuddyWater. The malware's second stage is downloaded from IP address
185.244.149[.]218.
Moreover, it appears MuddyWater hacked servers located in countries targeted by them. For example, Omri Segev
Moyal, who recently joined Clearsky as a strategic advisor, identified the following compromised website uses by
the group – a website from Pakistan: hxxp://corplink[.]com[.]pk/wp-content/themes/buisson/16433.jpg
This address communicates with several malicious files, one of them is a file named 'Nayatel.server.docx' which
impersonating a Pakistani 'Fiber-to-the-Home' (FTTH) services provider:

7 https://twitter.com/Timele9527

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 4 of 17

Attack infrastructure analysis - June 2019

Furthermore, we identified a compromised server by MuddyWater in China: hxxps://bbs[.]kafan[.]cn/thread2150909-1-1.html

Attack Vector 2 – CVE-2017-0199
CVE-2017-0199 is a Microsoft Office allow remote attackers to execute arbitrary code via a crafted document, aka
"Microsoft Office/WordPad Remote Code Execution Vulnerability w/Windows API8.

Vulnerable versions
Microsoft Office 2007 SP3, Microsoft Office 2010 SP2, Microsoft Office 2013 SP1, Microsoft Office 2016,
Microsoft Windows Vista SP2, Windows Server 2008 SP2, Windows 7 SP1, Windows 8.1
MuddyWater has not used this TTP previously. In contrast, two years ago Palo Alto revealed that this penetration
vector was used by another Iranian group named OilRig9.
For example, recently a file was uploaded to VirusTotal that impersonated a document written in Russian. The
document was identical to previous ones we have seen. In the known attack vector, the file communicates with
IP address 185.185.25[.]175 on port 80. If the file receives positive indication from the server, the following
redirections are carried out to the server10.

8

https://nvd.nist.gov/vuln/detail/CVE-2017-0199

9 https://unit42.paloaltonetworks.com/unit42-oilrig-group-steps-attacks-new-delivery-documents-new-injector-trojan/
10 https://any.run/report/36ccae4dffc70249c79cd3156de1cd238af8f7a3e47dc90a1c33476cf97a77b0/3bf82792-2ba1-4823-a7d8-b8c8c792cf61#http

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 5 of 17

Attack infrastructure analysis - June 2019

If the redirection fails, like in previous files we detected, the user is redirected to Wikipedia instead:

Below is a screenshot from Shodan of the server. As seen, it still redirects to Wikipedia:

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 6 of 17

Attack infrastructure analysis - June 2019
The
documents
were
identified by only three
antivirus engines. This is in
stark comparison to a previous
attack we reported on 11 , in
which the documents were
identified 32 times.
Moreover, in May we
reported on twitter about
another suspicious file that
targeted entities in Turkey, via
the same attack vector.
First type of file
In the first stage, after the file is opened the following
error message appears.
After the victim approves, another error message
appears which requests the victim to recover the
contents of the document:

If the victim confirms, the vulnerability will activate, and the Word software will communicate to the C2 server:

The contents of the text file redirect to the malware's C2 server. Then, several communications are carried out to
the C2 server with the address hxxp://plet[.]dk/css/css.css:

11 https://www.clearskysec.com/muddywater-targets-kurdish-groups-turkish-orgs

https://www.clearskysec.com/muddywater-operations-in-lebanon-and-oman/
© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 7 of 17

Attack infrastructure analysis - June 2019

As of June 1, the files on the server receives the value 0:
According to URLhaus12, the website is likely hacked:

Currently the domain's IP address is using Cloudflare service:

12 https://urlhaus.abuse.ch/

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 8 of 17

Attack infrastructure analysis - June 2019

Furthermore, it is inaccessible and only shows a warning by Cloudflare about a malicious page.
Second type of file
The second type of file exploits CVE-2017-0199 vulnerability, but unlike the first file, communication is carried out
directly to servers used in previous MuddyWater's attacks (187.185.25[.]175(. We believe that in future attack
MuddyWater will adopt vulnerability exploitation as a first stage.

Note that this file also redirects to Wikipedia if it does not receive a reply from the server:

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 9 of 17

Attack infrastructure analysis - June 2019

Malware analysis – RAT
We discovered a RAT file that communicates to the aforementioned IP address. The RAT was scanned on AnyRun
by an unknown user in late May.
First, the RAT is extracted with the PowerShell. Seen in the following image is its execution. Initially it
communicates with the server, which activates a php script named 'game'.

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 10 of 17

Attack infrastructure analysis - June 2019
To our understanding, this is an initial script which requests the compromised computer to report back to the
attacker about processes running on the system. After receiving indication from the C2 server
(hxxp://185.244.149[.]218/game.php), an encoded base64 output is sent to the attacker about these processes:

Afterwards, similarly to other files attributed to files in this camgains, it sends dozens of communicates requests
to its C2 server in order to receive commands. However, this sample did not receive any response from the server,
and therefore no new actions were taken:

MuddyWater impersonation entities
Like previous attacks, most of the targets impersonate to entities in countries that surround Iran. They
impersonate in this campaign to the following actors:
•
•
•
•
•
•
•
•

Kurdish groups (for example Komala – a Kurdish-Iranian party in Iraq).
Actors connected to the Iraq government.
Actors connected to the Tajikistan government.
Actors connected to the Pakistan government.
Actors connected to communication company in Pakistan.
Unknown actors that are connected to India.
Unknown actors in the UAE.
Unknown actors in Cyprus.
© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 11 of 17

Attack infrastructure analysis - June 2019
The combained attack vector
We identified several files that
leverage both of the TTPs, presented
above.
Opening the file leverages CVE2017-0199 and sends a request to
the hacked server.
Concurrently, the aforementioned
files are created. The file conducts
several communication requests
with the compromised server in an
attempt to download a JPG file that contains that malicious macro.

In our investigation, the C2 server communication failed; however, we detected a sample of this file on VT.

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 12 of 17

Attack infrastructure analysis - June 2019
Despite having the file extension 'JPG', it is in fact a Doc file embedded with the
following Macro. Similar to the first vector we described, the Macro executed an
embedded Excel file via DCOMLaunch:

In a similar fashion to previous attacks, two files are created within the 'Temp' folder.
These files contain segments of the malicious code used to extract the POWERSTATS
malware:
1. 'icon.ico' create "Wscript.Shell" Object and run WScript.Arguments.
2. 'Picture.jpg' contains the malicious code of the second stage malware. It is encoded by multiple layers of
obfuscated VBScript (VBE), JavaScript and PowerShell code.

The contents of the documents
The documents can be categorized into two groups.
The first group
Documents that resemble the previous documents used by MuddyWater. Some of these documents are almost
exact copies in terms of content (while changing the attack method). Below is a comparison between them:
A document that exploits a macro code in order to communicate with the server (from the report Iranian APT
MuddyWater Attack Infrastructure Targeting Kurdish Political Groups and Organizations in Turkey):

A document from the current campaign that exploits the CVE-2017-0199 vulnerability:
© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 13 of 17

Attack infrastructure analysis - June 2019

Both of them are disguised as official documents of the regional government of Kurdistan. Moreover, the new
documents' OLE data is generic, while in previous attacks they contained fraudulent names.
The second group
Documents written in English and disguised as unofficial documents from countries surrounding Iran (India and
Tajikistan for example). Unlike MuddyWater's known attack vectors, the content is not blurred, and has no request
to click on 'Enable Content'.

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 14 of 17

Attack infrastructure analysis - June 2019

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 15 of 17

Attack infrastructure analysis - June 2019
Indicators of Compromise
f5ef4a45e19da1b94c684a6c6d51b86aec622562c45d67cb5aab554f21eb9061
d5b7a5ae4156676b37543a3183df497367429ae2d01ef33ebc357c4bdd9864c3
d77d16c310cce09b872c91ca223b106f4b56572242ff5c4e756572070fac210f
98f0f2c42f703bfbb96de87367866c3cced76d5a8812c4cbc18a2be3da382c95
200c3d027b2d348b0633f8debbbab9f3efc465617727df9e3fdfa6ceac7d191b
951585840a07a6496b0270f1028281fcb65d5b9e9a6ed613ca8809b258ed729f
1dae45ea1f644c0a8e10c962d75fca1cedcfd39a88acef63869b7a5990c1c60b
10157ab25bab7891068538111333a2101b987e930d5deb7bb60ed63cf7ca197d
0a9d295016417b00457d4a031b5c52eea41bcde3465ac517767d8795a6a213eb
20bf83bf516b12d991d38fdc014add8ad5db03907a55303f02d913db261393a9
e2867e2255cad213fcc5752a7062882e92870c57
8d1464e0cac7ea8f37e83fd142212c95db20fe77
4fe389bc1ea85896b4ebb6fe26aa40a6e3f8e9ca
592f0d9d7185eadab0509fdafdc305ab
65978dd3d6b3a518f465676aa6bd876e
bb6fda2cdc852112544d2598a784d04f
6cb076f1f42573c5c43083a89bcfe442
BEB6A4354549AE4F5579F25865EA8967
66[.]219[.]22[.]235
83[.]171[.]238[.]62
185[.]185[.]25[.]175
185[.]244[.]14[.]218
hXXp://185[.]185[.]25[.]175/sDownloads/
hXXp://185[.]185[.]25[.]175/upl[.]php
hXXp://185[.]185[.]25[.]175/ref45[.]php
MISP event 1583

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 16 of 17

Attack infrastructure analysis - June 2019

Images provided by pexels.com. All images are
protected under the Creative Commons Zero (CC0)
license ("CC0 Content"), or Pexels License
.
/www.pexels.com/photo-license
www.pexels.com/terms-of-service

2019 ©All rights reserved to ClearSky Security Ltd.
www.clearskysec.com - info@clearskysec.com

© 2019 All rights reserved to Clearsky Security Ltd.

www.clearskysec.com - info@clearskysec.com

Page 17 of 17