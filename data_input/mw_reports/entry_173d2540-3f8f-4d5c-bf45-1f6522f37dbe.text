9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

Branch: master

CyberThreatIntel / offshore APT organization / Bitter / 27-08-19 / Malware analysis 31-08-19.md

Find file Copy path

StrangerealIntel Update Malware analysis 31-08-19.md
c652dc8 7 hours ago
1 contributor
Raw Blame History
116 lines (100 sloc)

9.6 KB

Malware analysis on Bitter APT campaign (31-08-19)

Table of Contents

Malware analysis
Initial vector
ArtraDownloader
Cyber Threat Intel
Indicators Of Compromise (IOC)
References MITRE ATT&CK Matrix
Links
Original Tweet
Link Anyrun
Documents

Malware-analysis
Initial vector

Use a document with a remote template injection as initial vector. This request http[:]//maq.com.pk/ for be redirected on the next URL.

This seconds URL (http[:]//maq.com.pk/wehsd) send an RTF exploit.

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

1/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

This exploit firstly executes a request by WebDAV and after by WebClient service for download the backdoor on the final address
(http[:]//maq.com.pk/wehs) and execute it.

Here we can see the redirection and the data sended on the victim.

ArtraDownloader
https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

2/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

In the first, we can see that launch by the factory option for separate the application of the current Explorer instance for avoid if one
crashes the other stays alive (C:\Windows\explorer.exe /factory,{75dff2b7-6936-4c06-a8bb-676a7b00b24b} -Embedding). Secondly, we
can note encoded string pushed on a function and the result is moved on another registry as storage for be used by the backdoor.

In observing this function we can resume by the following algorithm used for decode these strings : for each byte of the string -> value of
the byte -1 -> get Unicode value -> convert to char.

We can edit a script for decode the encoded string.

Now we can see the actions did by the malware.

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

3/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

Once this done, we can see on the entry point, this uses the startupinfo structure to specify window properties, verify the header of the PE
and the get the environment values for create the process. The malware is coded in C++ language.

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

4/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

5/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

We can observe that the malware pushes the persistence by a Run key in the registry. We can note too that use DOS commands with an
environment value ("C:\ProgramData\Ntuser\winlgn.exe") for launch the backdoor.

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

6/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

7/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

8/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

This query the registry for getting, the version of the OS and proceeds for identifying the victimʼs machine GUID by the
HKLM\SOFTWARE\Microsoft\Cryptography\MachineGuid registry key.

This use too, the EncodePointer function for encoding a specified pointer (encoded pointers can be used to provide another layer of
protection for pointer values).

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

9/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

After performing the reconnaissance actions, this can send a query as pulse with the informations to the C2, the URL to send is decoded
and an additional operation give the final URL.

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

10/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

11/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

12/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

The data are encoded by the algorithm too, with the script, we can decode the strings and see that the roles and data send to the C2.
https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

13/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel
SNI=VTFS.QD&UME=Xjoepxt!8!Qspgfttjpobm&OPQ=benjo&IVR=VTFS.QD$$benjoAA11482.572.3314613.96675&st=0

the Anyrun sandbox)

(Here from

We can resume all the variables used and the type of the informations sent in the C2.

Variable
SNI
UME
OPQ
IVR
st

Description
Computer name
OS Version
Account name
[Computer name]##[Account name]@@[GUID]
downloaded file executed successfully ?

Cyber kill chain
This process graph represents the cyber kill chain of Bitter sample.

Cyber Threat Intel
Since the last 2 weeks, the C2 domain have changed (.193 to .198) due to this are on the same subnet of the Verdina organization (Bulgaria
cloud provider).

We can note on the WHOIS information that this registered in Ras al-khaimah location.

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

14/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

The location is placed in the business place of the city.

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

15/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

We can note that two phone numbers with the country indicate (Indian and Iranian) have the same address for two companies.

In Ras al-Khaimah, there is no corporate tax, no profits, no customs duties, no inheritance tax, it is not excluding that the group Bitter
chose this place as a tax haven for their operations.

References MITRE ATT&CK Matrix

List of all the references with MITRE ATT&CK Matrix

Enterprise tactics
Execution
Persistence
Discovery
Lateral Movement
C&C

Technics used
T1203 - Exploitation for Client Execution
T1060 - Registry Run Keys / Startup Folder
T1012 - Query Registry
T1105 - Remote File Copy
T1105 - Remote File Copy

Ref URL
https://attack.mitre.org/techniques/T1203
https://attack.mitre.org/techniques/T1060
https://attack.mitre.org/techniques/T1012
https://attack.mitre.org/techniques/T1105
https://attack.mitre.org/techniques/T1105

Indicators Of Compromise (IOC)
List of all the Indicators Of Compromise (IOC)
https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

16/17

9/2/2019

CyberThreatIntel/Malware analysis 31-08-19.md at master · StrangerealIntel/CyberThreatIntel

Indicator
Urgent Action.docx
smss.exe
maq.com.pk
203.124.43.227
http[:]//maq.com.pk/
http[:]//maq.com.pk/wehsd
http[:]//maq.com.pk/wehs
http[:]//onlinejohnline99.org/kvs06v.php
onlinejohnline99.org
93.123.73.193
93.123.73.198

Description
34b53cd683f60800ac4057d25b24d8f083f759d024d22b4e5f2a464bc85de65
dcb8531b0879d46949dd63b1ac094f5588c26867805d0795e244f4f9b8077ed
Domain requested
IP requested
HTTP/HTTPS requests
HTTP/HTTPS requests
HTTP/HTTPS requests
HTTP/HTTPS requests
Domain C2
IP C2
IP C2

This can be exported as JSON format Export in JSON

Links

Original tweet: https://twitter.com/RedDrip7/status/1164855381052416002
Anyrun Link:
Urgent Action.docx
Docs :
Bitter Analysis by Unit42
Tool for decoding the encoded strings of ArtraDownloader
YARA Rule Bitter Variant1 (August 2019)

https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/offshore APT organization/Bitter/27-08-19/Malware analysis 31-08-19.md

17/17