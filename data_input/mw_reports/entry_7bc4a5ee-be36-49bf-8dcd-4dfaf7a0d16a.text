Anatomy
of Native IIS Malware
Zuzana Hromcova | Malware Researcher, ESET

#BHUSA @BlackHatEvents

Anatomy
of Native IIS Malware
C++
libraries

Internet
Information
Services
#BHUSA @BlackHatEvents

How popular
is IIS software?

4-7%

of websites use
IIS server*

#BHUSA

@BlackHatEvents

*Netcraft: May 2021 Web Server Survey

4-7%

of websites use
IIS server*

#BHUSA

@BlackHatEvents

*W3Techs: Usage statistics of web servers

4-7%

of websites use
IIS server*

#BHUSA

@BlackHatEvents

Microsoft Exchange
email servers with

Outlook
on the web

OWA

#BHUSA

@BlackHatEvents

Shodan result for public servers with OWA running Microsoft Exchange 2013 or 2016
(query for the IIS banner X-AspNet-Version and Outlook in the title):

Microsoft Exchange
email servers with

OWA

#BHUSA

@BlackHatEvents

IIS backdoors
spreading via ProxyLogon
Government
institutions
in three countries in
Southeast Asia

A major telecom
company
in Cambodia

Private
companies
in Canada, USA, South
Korea and others

#BHUSA

@BlackHatEvents

Government
espionage
Infiltrating government
mailboxes

Compromised
websites

SEO fraud
Crime schemes to
manipulate SERP

Targeting
e-commerce
Stealing credentials &
credit card information

IIS malware serving
malicious content &
adware

C&C traffic
routing
Compromised IIS server
as a malicious proxy
#BHUSA

@BlackHatEvents

Known malicious IIS modules:

ISN
IIS v7.0

2007

2013

Known malicious IIS modules:

RGDoor
ISN
IIS v7.0

2007

2013

2018

Known malicious IIS modules:

RGDoor
ISN

Native malware

IIS v7.0

2007

2013

2018

2019

Known malicious IIS modules:

RGDoor
ISN

Native malware

IIS v7.0

2007

2013

Managed malware

2018

2019

2020

Known malicious IIS modules:

RGDoor

IIS-Raid

ISN

Native malware

IIS v7.0

2007

2013

Managed malware

2018

2019

2020

2021

Known malicious IIS modules:

RGDoor

IIS-Raid

ISN

Native malware

IIS v7.0

2007

2013

Managed malware

2018

2019

2020

2021

Our research

Our research
Malicious native IIS modules (C++
libraries)

80+ unique samples from our telemetry
and VirusTotal
14 malware families
(10 never documented)
Victim information from our telemetry
and internet-wide scans
Detailed information and analyses in
the white paper
#BHUSA

@BlackHatEvents

Malicious native IIS modules

Architecture
Reversing
TTPs
Defense

Malicious native IIS modules

Architecture

Internet Information Services (IIS)
• Microsoft web server software
• Modular architecture (since v7.0)

• IIS services configured to run at each system start (World Wide
Web Publishing Service, Windows Process Activation Service or
Application Host Helper Services)
• IIS Worker Process (w3wp.exe)
• Handles inbound requests
• Loads all IIS modules configured in
%windir%\system32\inetsrv\config\ApplicationHost.config

#BHUSA

@BlackHatEvents

Request-processing pipeline

#BHUSA

@BlackHatEvents

Event handlers

Events

generate notifications

handle notifications

Class inheriting from CHttpModule:

Event
notification

Post-event
notification

#BHUSA

@BlackHatEvents

Events

generate notifications

#BHUSA

@BlackHatEvents

Module classes

Class inheriting from CHttpModule:

implement event handlers
Class inheriting from CGlobalModule:

#BHUSA

@BlackHatEvents

Module classes

Class inheriting from CHttpModule:

implement event handlers
Class inheriting from CGlobalModule:

#BHUSA

@BlackHatEvents

Module classes

Class inheriting from CHttpModule:

implement event handlers
Class inheriting from CGlobalModule:

#BHUSA

@BlackHatEvents

RegisterModule
DLL export / module entrypoint
1. Creates instances of the
core classes

#BHUSA

@BlackHatEvents

RegisterModule
DLL export / module entrypoint
1. Creates instances of the
core classes
2. Registers module for
server events

#BHUSA

@BlackHatEvents

RegisterModule
DLL export / module entrypoint
1. Creates instances of the
core classes
2. Registers module for
server events
3. Sets priority for the
module

#BHUSA

@BlackHatEvents

Malicious native IIS modules

Reverse-engineering

1 Import relevant interfaces (implemented in iiscore.dll):
IHttpContext, IHttpModuleRegistrationInfo, IHttpRequest,
IHttpResponse, IPreBeginRequestProvider…

#BHUSA

@BlackHatEvents

See Group 9 in the paper

2 Start with RegisterModule export
• Which handlers are implemented?
• Initialization?

#BHUSA

@BlackHatEvents

3 Identify implemented handlers

See Group 7 in the paper

malicious handler

malicious handler
malicious handler

#BHUSA

@BlackHatEvents

3 Identify implemented handlers

See Group 12 in the paper

malicious handler

benign handler

benign handler

#BHUSA

@BlackHatEvents

3 Identify implemented handlers

See Group 12 in the paper

malicious handler

benign handler

benign handler

4 Refer to the Native-Code API Reference for the analysis
#BHUSA

@BlackHatEvents

Malicious native IIS modules

Understanding the TTPs

1 IIS backdoors
execute backdoor commands on IIS server

Backdoor commands
• Get system information
• Upload/download files
• Execute files or shell commands
• Create reverse shell
• Create/list/move/rename/delete files and folders

Special HTTP request
with backdoor commands

• Map local drives to remote drives

• Exfiltrate collected data

1
2

Command output

Attacker HTTP requests
• A custom HTTP header present
•

An embedded password in the URL, request body,
headers (hardcoded password or password hash
in the malware)

•

A specific format of URL or request body

•

A more complex condition

#BHUSA

@BlackHatEvents

Attacker HTTP request example
See Group 7 in the paper

#BHUSA

@BlackHatEvents

2 IIS infostealers

See Group 5 in the paper

intercept traffic and steal data from legitimate visitors

#BHUSA

@BlackHatEvents

DEMO

#BHUSA

@BlackHatEvents

See Group 12 in the paper

3 IIS injectors
serve malicious content to legitimate visitors

#BHUSA

@BlackHatEvents

See Group 9 in the paper

4 IIS proxies
relay traffic between a compromised host and the C&C server

#BHUSA

@BlackHatEvents

5 SEO fraud

See Group 13 in the paper

deceive search engine crawlers
• Manipulates content served to search engine crawlers to boost SEO for selected websites
• Legitimate user requests are ignored by the malware
• Techniques used:
• Keyword stuffing

• Injecting a list of backlinks
• Redirecting the crawlers (turning the compromised website into a doorway page)

• This is not Black Hat SEO
• A third-party website benefits from the manipulation, not the one serving the manipulated content (this is
likely sold as a service)
• C&C communication to obtain configuration data
• Other malicious modes present (e.g. backdoor, proxy)
#BHUSA

@BlackHatEvents

Malware
family

Backdoor

Info
stealer

Proxy

SEO
fraud

Injector

Group 1
Group 2
Group 3
Group 4
Group 5

Known IIS
malware families
See the paper for detailed analyses

Group 6

Group 7
Group 8
Group 9
Group 10
Group 11
Group 12A
Group 12B
Group 12C
Group 13

Group 14

#BHUSA

@BlackHatEvents

Malicious native IIS modules

Detection, mitigation
and remediation

Detecting compromised servers

Inspect installed
modules

#BHUSA

@BlackHatEvents

#BHUSA

@BlackHatEvents

Detecting compromised servers

Check IIS logs

the default location is
%SystemDrive%\inetpub
\logs\LogFiles

Inspect installed
modules
via IIS Manager, AppCmd.exe
or inspect the configuration file
%windir%\system32\inetsrv\
config\ApplicationHost.config

Scan for known
malware families
use IoCs and YARA rules listed
on our GitHub repository

#BHUSA

@BlackHatEvents

DEMO

#BHUSA

@BlackHatEvents

Mitigation (of compromise vectors)

Prevent
server exploitation

•
keep your OS up-to-date
•
limit services exposed to the internet
• use strong passwords and 2FA for
dedicated administrative accounts

Prevent installing
malicious (e.g.,
trojanized) modules

• only install modules from trusted
sources
• consider using an endpoint
security solution
#BHUSA

@BlackHatEvents

Conclusion

Black Hat Sound Bytes

Anatomy of Native IIS Malware

1

IIS malware:
cybercrime AND
cyberespionage tool
we documented 14 families (10 new);
consider them in your threat model

2
Get the full
white paper:
for a comprehensive guide
on detecting, analyzing and
understanding IIS malware

3

Use the IoCs and
YARA rules for
detection:
get them from
the ESETresearch GitHub
https://github.com/eset/malwareioc/tree/master/badiis

#BHUSA

@BlackHatEvents

Thanks
for watching!
Zuzana Hromcova
ESET Malware Researcher
@zuzana_hromcova

www.welivesecurity.com
@ESETresearch