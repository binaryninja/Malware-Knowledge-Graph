The Real Shim Shady
William Ballenthin, FireEye
Jonathan Tomczak, Mandiant

Copyright ¬© 2015, FireEye,
Copyright
Inc. All¬©rights
2015,reserved.
FireEye, Inc. All rights reserved.

1

Bio, plan
ÔÇß William Ballenthin, Reverse Engineer
- FLARE (FireEye Labs Advanced Reverse Engineering) team
- Malware analysis, forward and backward engineering

ÔÇß Jonathan Tomczak, Consultant
- Mandiant Professional Services

- Incident response, forensics, tool development

ÔÇß Todays Topic: Case Study and Investigative Techniques for Hijacked
Application Compatibility Infrastructure.
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

2

Put out the Fire!
ÔÇß Working the malware triage queue, encountered interesting situation:
- Client targeted by phishing emails
- Large deployment FireEye boxes didn‚Äôt fire
- Malware maintained persistence, somehow

ÔÇß What‚Äôs going on? How to fix detection & investigative methodology?

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

3

DLL Injection via Shims
ÔÇß Malware: self-extracting RAR
drops KORPLUG launcher (elogger.dll)

loading shellcode backdoor (elogger.dat)
ÔÇß elogger.dat does a little of everything: manually loads PE payload,
injects, privesc, installs service, HTTP protocol

ÔÇß Also, installs an ACI shim:
- Writes two (32/64-bit) hardcoded, embedded SDB files to disk
- Invokes sdbinst.exe

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

4

WHAT‚ÄôS THE ACI?
What are shims and why are they on my system?

Copyright ¬© 2014, FireEye,
Copyright
Inc. All¬©rights
2015,reserved.
FireEye,CONFIDENTIAL
Inc. All rights reserved.

5

Application Compatibility Infrastructure
ÔÇß Manages and resolves application compatibility issues with updates to
Microsoft Windows
ÔÇß Configured via freely available Application Compatibility Toolkit (ACT)
ÔÇß API hooking (& more) built into the executable Loader
- ‚ÄúShims‚Äù typically implemented as code (DLLs) or configuration (disable feature)
- Shims described by databases (SDB files) indicating source and target
- SDBs registered with the OS, queried by loader

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

6

Application Compatibility Infrastructure, II
ÔÇß Targets specified by executable file metadata, including:
- Filename
- PE checksum
- File size
- Version info fields, etc.

ÔÇß Lots of shims to play with
- Dozens of preconfigured quickfixes (redirect file reads, change heap behavior)
- Thousands of SDB entries distributed by MS
- Some undocumented features
‚Ä¢ EMET uses ACI to inject its DLL into processes on execution
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

7

SDB contents
<EXE>
<NAME type='stringref'>OREGON32.EXE</NAME>
<APP_NAME type='stringref'>The Oregon Trail v1.2</APP_NAME>
<VENDOR type='stringref'>Minnesota Educational Computing Corp.</VENDOR>
<EXE_ID type='hex'>568058f1-da4f-4105-8f72-edd5d2a4aaf3</EXE_ID>
<APP_ID type='hex'>82f31111-af62-4849-b866-14c4e748e33c</APP_ID>

<MATCH_MODE type='integer'>0x2</MATCH_MODE>
<MATCHING_FILE>
<NAME type='stringref'>OREGON32.DLL</NAME>
</MATCHING_FILE>
<SHIM_REF>

<NAME type='stringref'>EmulateGetDiskFreeSpace</NAME>
<SHIM_TAGID type='integer'>0x23298</SHIM_TAGID>
</SHIM_REF>
</EXE>
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

8

SHIM TECHNIQUES
Shim development, creation, and deployment

Copyright ¬© 2014, FireEye,
Copyright
Inc. All¬©rights
2015,reserved.
FireEye,CONFIDENTIAL
Inc. All rights reserved.

9

The Application Compatibility Toolkit

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

10

SDB deployment
ÔÇß sdbinst.exe registers SDB files with operating system
- Creates uninstallation entries in the control panel

- Add values to Registry keys:
‚Ä¢ HKLM\SOFTWARE\Microsoft\Windows
NT\CurrentVersion\AppCompatFlags\Custom
‚Ä¢ HKLM\SOFTWARE\Microsoft\Windows
NT\CurrentVersion\AppCompatFlags\InstalledSDB

ÔÇß Microsoft recommends packaging in an MSI and deploying via GPO
ÔÇß Directly adding the Registry values circumvent sdbinst.exe and extra
control panel entries
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

11

Fun shims
Shim Name

Purpose

DisableWindowsDefender

‚ÄúThe fix disables Windows Defender for
security applications that do not work with
Windows Defender.‚Äù

CorrectFilePaths

Redirect file system paths

LoadLibraryRedirectFlag

Change load directory of DLLs

NoSignatureCheck

??? ÔÅä

RelaunchElevated

Ensure an EXE runs as admin

TerminateExe

??? ÔÅä

VirtualRegistry

Registry redirection and expansion

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

12

Trick 1: DLL Injection via shims (seen in wild)
ÔÇß Self-extracting RAR
drops KORPLUG launcher (elogger.dll)

loading shellcode backdoor (elogger.dat)
ÔÇß elogger.dat does some of everything: manually loads PE payload,
injects, privesc, installs service, HTTP protocol

ÔÇß Also, installs an ACI shim:
- Writes two (32/64-bit) hardcoded, embedded SDB files to disk
- Invokes sdbinst.exe

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

13

SDB contents
<DATABASE><NAME type='stringref'>Brucon_Database</NAME>
<DATABASE_ID type='guid'>503ec3d4-165b-4771-b798-099d43b833ed</DATABASE_ID>
<LIBRARY> <SHIM>
<NAME type='stringref'>Brucon_Shim</NAME>
<DLLFILE type='stringref'>Custom\elogger.dll</DLLFILE>
</SHIM></LIBRARY>

<EXE>
<NAME type='stringref'>svchost.exe</NAME>
<APP_NAME type='stringref'>Brucon_Apps</APP_NAME>
<EXE_ID type='hex'>e8cc2eb6-469d-43bc-9d6a-de089e497303</EXE_ID>
<MATCHING_FILE><NAME type='stringref'>*</NAME></MATCHING_FILE>

<SHIM_REF><NAME type='stringref'>Brucon_Shim</NAME></SHIM_REF>
</EXE></DATABASE>

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

14

Analysis

ÔÇß Persistence configured via opaque file format
ÔÇß Hardcoded SDB file easily sig-able via filenames, IDs
- Payload file exists in the clear, in very limited set of directories

‚Ä¢ C:\Windows\AppPatch\Custom\
‚Ä¢ C:\Windows\AppPatch\Custom\Custom64\

ÔÇß FireEye identified filename elogger.dll often reused in KORPLUG &
SOGU campaigns.

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

15

Trick 2: Argument replacement via shims (seen in lab)

ÔÇß CorrectFilePath fix redirects arguments from the application‚Äôs path to
an attacker‚Äôs specified path
- Trivial to hook into CreateProcess, WinExec, ShellExecute

ÔÇß Custom program mine.exe, launches C:\windows\temp\1.exe
- Add shim: redirects C:\windows\temp\1.exe to C:\dump\1.exe
- CorrectFilePath: ‚ÄúC:\windows\temp\1.exe; C:\dump\1.exe‚Äù

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

16

SDB contents
<DATABASE><TIME type='integer'>0x1d100fac0a4a7fc</TIME>
<NAME type='stringref'>minesdb</NAME>
<DATABASE_ID type='guid'>
2840a82e-91ff-4f29-bff2-fd1e9780b6eb</DATABASE_ID>
<EXE>
<APP_NAME type='stringref'>mine.exe</APP_NAME>
<MATCHING_FILE><NAME type='stringref'>*</NAME></MATCHING_FILE>
<SHIM_REF>
<NAME type='stringref'>CorrectFilePaths</NAME>
<COMMAND_LINE type='stringref'>
"C:\Windows\Temp\1.exe; C:\dump\1.exe‚Äú
</COMMAND_LINE>
</SHIM_REF></EXE></DATABASE>
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

17

Trick 2: Argument replacement via shims, II

ÔÇß Analysis:
- Consider the targeted process is cmd.exe
‚Ä¢ Hidden persistence, MITM of process creation
‚Ä¢ #DFIR confusion
- Configured via opaque file format
- Payload not limited to specific directories

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

18

Trick 3: Shellcode injection via shims (seen in wild)

ÔÇß Phishing email leads to dropper
dropper installs template SDB and modifies them dynamically
SDB declares shellcode that it injects on executable load

payload is a downloader for other stages
ÔÇß First identified by TrendMicro‚Ä¶

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

19

SDB contents
<DATABASE><NAME type='stringref'>opera.exe</NAME>
<DATABASE_ID>
538f5e1c-932e-4426-b1c9-60a6e15bcd7f</DATABASE_ID>
<LIBRARY><SHIM_REF><PATCH>
<NAME type='stringref'>patchdata0</NAME>
<PATCH_BITS type='hex'>040000c‚Ä¶0000000000000000</PATCH_BITS>
</PATCH></SHIM_REF></LIBRARY>
<EXE><APP_NAME type='stringref'>opera.exe</APP_NAME>
<MATCHING_FILE><NAME>opera.exe</NAME></MATCHING_FILE>
<PATCH_REF>
<NAME type='stringref'>patchdata0</NAME>
<PATCH_TAGID type='integer'>0x6c</PATCH_TAGID>
</PATCH_REF></EXE></DATABASE>
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

20

PATCH_BITS

ÔÇß Windows loader writes arbitrary bytes into module memory
- PATCH_MATCH to verify target of memory write
- PATCH_REPLACE stamps in raw bytes

- Can target both EXE and DLL modules

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

21

Patch details
00000000 (04)

opcode: PATCH_MATCH

00000000 (04)

opcode: PATCH_REPLACE

0000000c (04)

rva: 0x00053c2e

0000000c (04)

rva: 0x00053c2e

00000014 (64)
module_name:
u'kernel32.dll'
00000054 (05)

pattern: 9090909090

00000014 (64)
module_name:
u'kernel32.dll'
00000054 (07)

pattern: e8321a0700ebf9

disassembly:
0x53c2e: nop

0x53c2f: nop
0x53c30: nop

disassembly:
0x53c2e: call 0x000c5665

0x53c33: jmp 0x00053c29

0x53c31: nop
0x53c32: nop
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

22

Patch details, II
00000000 (04)

opcode: PATCH_MATCH

0000000c (04)

rva: 0x000c5665

00000014 (64)
module_name:
u'kernel32.dll'

00000054 (08)
pattern:
0000000000000000

00000000 (04)

opcode: PATCH_REPLACE

0000000c (04)

rva: 0x000c5665

00000014 (64)

module_name: u'kernel32.dll'

00000054 (14)
pattern:
83042402609ce8030000009d61c3
disassembly:
0xc5665: add dword [esp],2
0xc5669: pushad
0xc566a: pushfd

0xc566b: call 0x000c566d
0xc5670: popfd
0xc5671: popad
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

0xc5672: ret

23

Patch details, III

< Multi-kilobyte shellcode downloader >

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

24

Patch details, summary
Legit Call
Kernel32.dll

Legit Code

Legit Call
Legit Code

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

25

Patch details, summary
Legit Call
Kernel32.dll

Legit Code

Hook

Legit Call
Legit Code

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

26

Patch details, summary
Legit Call
Kernel32.dll

Legit Code

Trampoline
Legit Call
Legit Code

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

27

Patch details, summary
Legit Call
Kernel32.dll

Legit Code

Legit Call
Fetch & exec
backdoor
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

Legit Code

28

Patch details, summary
Legit Call
Kernel32.dll

Legit Code

Return to trampoline
Legit Call
Legit Code

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

29

Patch details, summary
Legit Call
Kernel32.dll

Legit Code

Return to legit code

Legit Call
Legit Code

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

30

Patch details, summary
Legit Call
Kernel32.dll

Legit Code

Legit Call
Legit Code

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

31

Analysis

ÔÇß Persistence & injection by MS infrastructure!
ÔÇß External storage of shellcode in opaque format

ÔÇß Dynamic modification of SDB files from template
- Generates unique GUIDs for database ID
- Extensible payloads

- PATCH_BYTES not documented

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

32

FLYING THROUGH THE MATRIX
Understanding SDB files

Copyright ¬© 2014, FireEye,
Copyright
Inc. All¬©rights
2015,reserved.
FireEye,CONFIDENTIAL
Inc. All rights reserved.

33

SDB file format
ÔÇß The SDB file format is an undocumented Microsoft format
- apphelp.dll exposes ~254 exports for manipulating shims
- That doesn‚Äôt help for forensic analysis!

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

34

SDB file format, II
ÔÇß So, we reverse engineered it
ÔÇß Conceptually, like an indexed XML document
- Three main nodes: the index, the database structure, and a string table
- No compression, encryption, signatures, nor checksums

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

35

Consider the scenario
ÔÇß Shim definition: name & shim action
<LIBRARY> <SHIM>
<NAME type='stringref'>Brucon_Shim</NAME>
<DLLFILE type='stringref'>Custom\elogger.dll</DLLFILE>
</SHIM></LIBRARY>

ÔÇß Application definition: target & shim pointer
<NAME type='stringref'>svchost.exe</NAME>
<APP_NAME type='stringref'>Brucon_Apps</APP_NAME>
<SHIM_REF>
<NAME type='stringref'>Brucon_Shim</NAME>
<SHIM_TAGID type='integer'>0x47c</SHIM_TAGID>
</SHIM_REF>
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

36

python-sdb
ÔÇß Some tools exist for unpacking SDB files
- But they rely on the Windows API

ÔÇß python-sdb is a cross platform, pure Python library for parsing SDBs
- Python API makes it easy to build scripts that inspect SDB features

- Provided sample scripts dump database as various XML flavors

ÔÇß https://github.com/williballenthin/python-sdb

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

37

DETECTION METHODOLOGY
Investigating malicious shims at scale in a large environment

Copyright ¬© 2014, FireEye,
Copyright
Inc. All¬©rights
2015,reserved.
FireEye,CONFIDENTIAL
Inc. All rights reserved.

38

Consider the scenario
ÔÇß Trojan.mambashim
- Python (what, just read the source!?!)
- Obfuscated bytecode
- Installs service, or uses ctypes to dynamically create sdb and install

- sdb causes Windows loader to inject DLL payload launcher into putty44.exe

Would you have any idea this was happening to your environment?

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

39

Existing administrative tools?
ÔÇß Fact: Trojan.mambashim generates random sdb path using a dictionary
of English words, installs using sdbinst.exe
ÔÇß ACI Fails:
ÔÇß No central management for SDBs on a system
ÔÇß No Active Directory tools for SDB management
ÔÇß No accounting of ACI changes or rollback features
ÔÇß Win?
ÔÇß Maybe catch sdbinst.exe via process auditing?
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

40

ACI Integrity checking?
ÔÇß SDB files are not signed ÔÅå
ÔÇß Whitelisting SDBs by hash does not work

ÔÇß eg. collection across 6,000 hosts yields 18,000 unique SDB files
ÔÇß Embedded timestamps and installation order affect SDB integrity checks

ÔÇß If Office is installed before Visual Studio, and then vice versa on
another system, it may result in a different SDB.

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

41

Mass inspection & anomaly detection
ÔÇß Acquire, inspect %systemdrive%\*.sdb
ÔÇß Legitimate SDBs typically reside in Windows and Program Files

ÔÇß Attacker SDBs found in %USERSPROFILE%, working directories
ÔÇß Acquire, inspect
ÔÇß HKLM\SOFTWARE\Microsoft\Windows
NT\CurrentVersion\AppCompatFlags\Custom

ÔÇß HKLM\SOFTWARE\Microsoft\Windows
NT\CurrentVersion\AppCompatFlags\InstalledSDB

ÔÇß Default sdbs: drvmain, frxmain, msimain, pcamain, sysmain
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

42

Mass inspection & anomaly detection
ÔÇß Trojan.mambashim
- Random header timestamp (range 0-max int64 (!!!)) üëç

- Random compiler version (rand.rand.rand.rand) üëç
- EXE vendor name vendor üëç
- Random database ID (well, it‚Äôs a GUID‚Ä¶) üëç

- Random EXE ID (also GUID‚Ä¶) üëç

ÔÇß But, blacklist won‚Äôt scale
ÔÇß Good for hunting, not fire and forget
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

43

Mass inspection & anomaly detection, II
Microsoft-Windows-Application-Experience-Program-Telemetry.evtx

Compatibility fix applied to C:\PROGRAM FILES\Putty\putty44.exe.
Fix information: vendor, {7e4053fe-ade9-426f-9dc2-0bbfa76b5366},
0x80010156.

ÔÇß Do you have technology that can detect ‚Äúunusual entries‚Äù?
- Count tuple (hostname, vendor, application) & sort ASC
- Alert on new tuples?

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

44

Domain specific hashing
ÔÇß Realistically, Trojan.mambashim could be much nastier.

ÔÇß We don‚Äôt expect blacklisting to scale, that‚Äôs just playing catch up
ÔÇß We really want to whitelist:
ÔÇß But, can‚Äôt whitelist entire files by hash (see earlier)

ÔÇß Can hash shim & application definitions
ÔÇß Don‚Äôt expect these to change
ÔÇß Use this to build a whitelist!
ÔÇß shims_hash_shims.py
Copyright ¬© 2015, FireEye, Inc. All rights reserved.

45

Prepare for this scenario

ÔÇß https://github.com/ganboing/sdb_packer
ÔÇß Extract existing legit sysmain.sdb

ÔÇß Add new shim for explorer.exe, etc.
ÔÇß Payload: keylog data & shellcode that does exfil
ÔÇß Re-pack sysmain.sdb

ÔÇß Deploy
ÔÇß ???
ÔÇß Profit

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

46

Shims are real. Don‚Äôt get shimmed.
ÔÇß Both targeted and commodity threats are actively using ACI shims
ÔÇß There is no existing infrastructure for detection

ÔÇß Consider the risk

ÔÇß You are now the front line.

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

47

Prior work
ÔÇß ‚ÄúPersist It - Using and Abusing Microsoft Fix It Patches‚Äù - Jon Erickson/iSIGHT
@ BH ‚Äô14
https://www.blackhat.com/docs/asia-14/materials/Erickson/Asia-14-Erickson-Persist-It-Using-And-Abusing-Microsofts-Fix-ItPatches.pdf

ÔÇß ‚ÄúShim: A new method of injection‚Äù (in Russian)
ftp://os2.fannet.ru/fileechoes/programming/XA_159.PDF

ÔÇß ‚ÄúRoaming Tiger‚Äù - Anton Cherepanov/ESET @ ZeroNights ‚Äô14
http://2014.zeronights.org/assets/files/slides/roaming_tiger_zeronights_2014.pdf

ÔÇß ‚ÄúWindows - Owned By Default!‚Äù ‚Äì Mark Baggett @ DerbyCon 2013
ÔÇß ‚ÄúCompatibility Fix Descriptions‚Äù - MSDN
https://technet.microsoft.com/en-us/library/cc722305%28v=ws.10%29.aspx

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

48

THE END
Questions?

Copyright ¬© 2014, FireEye,
Copyright
Inc. All¬©rights
2015,reserved.
FireEye,CONFIDENTIAL
Inc. All rights reserved.

49

File Timestamp Indicators
ÔÇß Filesystem created timestamp indicates installation of SDB to the system
ÔÇß Windows Patch
ÔÇß Application Install
ÔÇß Malicious SDB that was pre-compiled before installation.
ÔÇß Registry timestamps show installation timestamp
ÔÇß Filesystem modified timestamp indicates that the SDB was recompiled.
ÔÇß Windows Patch
ÔÇß Application Install
ÔÇß Malicious injection into an existing SDB such as sysmain.sdb

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

50

Notes on artifacts
ÔÇß FireEye identified filename elogger.dll often reused in KORPLUG & SOGU
campaigns.
ÔÇß elogger.dll exports ShimMain and NotifyShims, which are undocumented
shim entry points. Some KORPLUG loaders also export these without SOGU
payloads referencing the ACI.
ÔÇß ‚ÄúRoaming Tiger‚Äù (ESET) campaign distributed SDB files with similar naming schemes:
elogger.dat

‚ÄúRoaming Tiger‚Äù

Brucon_Shim

AcProtect_Shim

Brucon_Apps

AcProtect_Apps

Brucon_Database

AcProtect_Database

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

51

Shim DLL exports
Shim DLL export name

Shim DLL export purpose

SE_DllLoaded

Callback during DLL load

SE_DLLUnloaded

Callback during DLL unload

SE_DynamicShim

Unknown

SE_GetProcAddress

Callback during
GetProcAddress

SE_InstallAfterInit

Callback after shim
complete

SE_InstallBeforeInit

Callback before shim
application

SE_IsShimDLL

Callback when shimming shim
DLL

SE_Process

Callback when EXE exiting

Copyright ¬© 2015, FireEye, Inc. All rights reserved.

52