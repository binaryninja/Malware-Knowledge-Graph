Tracking the entire
iceberg

- long-term APT malware C2
protocol emulation and scanning

Who am I?
@cci_forensics
Past Research

VB 2022

Motivation

Overview

VB 2022

Winnti 4.0

ShadowPad
High

Prevalence

Low

First-observed
year

2016 (start-up
sequence),
2018 (new C2
protocol)

2015

Scanning start
year

2019

2021

Supported
protocols

TCP/TLS/HTTP(S)/ TCP/SSL/HTTP(S)/
UDP
UDP/DNS

Unique feature

Server-mode

Multiple protocol
listening at a single
port

Target
Summary

Winnti 4.0

VB 2022

Winnti Malware

Kaspersky
Novetta

VB 2022

Winnti Malware 4.0
Macnica Networks
version 4.0
Initial component
Initial encryption
algorithm
Initial encryption key
cracking
Worker encryption
VB 2022

Version 3.0
Dropper
DES

Version 4.0
Loader and DAT file
AES

Easy

Hard

1-byte XOR and nibble swap DPAPI or AES with hostspecific key

Winnti Malware 4.0 (Cont.)
struct struc_work_config {
char campaignID[64];
char MAC_addr[6];
int c2_proto; // enum_proto
...
}
enum enum_proto {
none = 0x0,
TCP = 0x1,
HTTP = 0x2,
HTTPS = 0x3,
TLS = 0x4,
UDP = 0x5,
};
VB 2022

C2 Protocol

VB 2022

Packet Format
struct struc_custom_header
{
__int16 temp_key_seed;
__int16 unk_word; // initial value is 2
__int16 signature; // 0x45DB
int payload_len;
};

VB 2022

struct struc_custom_payload_init
{
int payload_type; //
request:0xEE775BAA/0x4563CEFA/0x5633CBAD,
response:0xFACEB007/0x5633CBAD
int unk_dword; // request:0,
response:0xC350/0xC352
GUID guid;
char null_bytes[14];
__int16 seq_num; // starting from 1
__int16 null_word;
};

Encryption

AppCall

VB 2022

HTTP Protocol

VB 2022

Customized packet size
Customized packet

HTTP: Size Calculation from Cookie
Value

$ python validate_cookie.py 640ABEFB16D2CE36E7E83E1B8BEF31B2500ABEFB
dw0=0xfbbe0a64, dw1=0x36ced216, dw2=0x1b3ee8e7, dw3=0xb231ef8b, dw4=0xfbbe0a50
The cookie value validated. dword key = 0x34
VB 2022

HTTP: Dummy Data in GET Request

Size = 0
Size = 0

VB 2022

Behavior After the Initial Handshake
struct struc_custom_payload_next
{
__int16 messageID;
...
__int16 signature; // 0x45db
int nested_payload_len;
struc_nested_payload nested_payload;
};

VB 2022

struct struc_nested_payload // at least 0x14 bytes
{
// e.g., cmd_ID=5 & dispatch_ID=1 order to send victim info
__int16 cmd_ID;
__int16 dispatch_ID;
...
int additional_data_len;
struc_data_cmd1 additional_data; // flexible size
};

Scanner Implementation
ZMap

• Internet-wide port scan
• TCP 443 & 80
• UDP 443 & 53 (customized
packet required)

Stand-alone
Python
Script

• HTTP(S): Decode and
Validate Cookie value
• Others: Get suspicious
responses with the same
size and different key

IDAPython
AppCall
VB 2022

• Decrypt response’s
customized packet
• Validate signature
and payload size in
the header

How to Differentiate Server-mode
Infections and C2 Servers
Server-mode: the same GUID as client, sequence number incremented
[DEBUG] server header: unknown word = 0x2, header signature = 0x45db, payload length = 0x2a
[*] server payload: payload type = 0xfaceb007, unknown dword = 0xc352, GUID = 0b8212dce364-4c18-ac0b-26382beb1387, sequence number = 2
C2: null GUID, sequence number reset
[DEBUG] server header: unknown word = 0x2, header signature = 0x45db, payload length = 0x2a
[*] server payload: payload type = 0xfaceb007, unknown dword = 0x0, GUID = 00000000-00000000-0000-000000000000, sequence number = 1
VB 2022

Result: Population by Protocol
UDP
TCP 5%
11%

TLS
35%

HTTP
20%

HTTPS
29%
TLS
VB 2022

HTTPS

HTTP

TCP

UDP

VB 2022

9
Fe
b20
Ap
r20
Ju
n20
Au
g20
O
ct
-2
D 0
ec
-2
0
Fe
b21
Ap
r21
Ju
n21
Au
g21
O
ct
-2
D 1
ec
-2
1
Fe
b22
Ap
r22
Ju
n22
Au
g22

ec
-1

D

number of active C2s

Result: Change in Number of Active C2s
25

20

15

1st
disclosure
2nd
disclosure

10

5

0

period

Public Reports Related to Winnti 4.0
C2s
Trellix

Recorded Future

VB 2022

ShadowPad

VB 2022

ShadowPad Malware

SentinelOne

VB 2022

C2 Protocol

TCP

HTTP(S)/UDP

Key size

4

2

Header size

0x14

8

Payload size in the initial
handshake packet

Up to 0x3F

HTTP(S): Up to 0x1F,

VB 2022

UDP: 0x10

C2 Protocol (Cont.)

Variant name
Variant1

C2 protocol

Config size

Attribution

Source

TCP/UDP

0x896

APT41

(aka ScatterBee)
Variant2
HTTP(S)

Positive
Technologies

0x85C

Tonto Team

ESET

0x85C

unknown

Positive
Technologies

Variant3
VB 2022

HTTP(S)

TCP Protocol
QuickLZ
struct struc_common_header
{
int session_key;
int plugin_and_cmd_id; // plugin_id (0x68) << 16 + cmd_id (0x51) by Variant1
int module_code; // 0
int payload_size_compressed; // QuickLZ
int payload_size_original;
};
VB 2022

TCP Protocol (Cont.)

white paper

VB 2022

Dr.WEB

HTTP(S) and UDP Protocols

struct struc_proto_header
{
__int16 session_key;
__int16 type; // 0 in HTTP, req=0x1001/res=(0x2002|0x5005) in UDP
__int16 session_src_id; // random 2 bytes, generated by both client/server
__int16 session_dst_id; // req=0, res=client's session_src_id
};
VB 2022

HTTP(S) and UDP Protocols (Cont.)

UDP packet encoding by Variant1

HTTP(S) packet encoding by Variant2

HTTP(S) packet encoding by Variant3
VB 2022

HTTP(S) and UDP Protocols (Cont.)
struc_proto_header
payload = TCP packet
struc_common_header
QuickLZ-compressed
payload

VB 2022

Scanner Implementation

Scanning start period
September 2021
October 2021
June 2022
VB 2022

Target protocol/port/variant
HTTP/443 (Variant2 & Variant3)
TCP/443 & UDP/53 (Variant1)
UDP/443 (Variant1), HTTP/80 (Variant3)

Scanner Implementation (Cont.)
ZMap

• Internet-wide port scan
• Targets as mentioned previously

Stand-alone
Python
Script
VB 2022

• Decode the response packet
• Validate the decoded values
• TCP: payload size fields
• HTTP(S)/UDP: type and
session_dst_id

Multiple Protocol Listening at a Single
Port

[*] config size = 0x85c
Hostname/port matched
..
[+] C2 Entry 0 (offset 0xbc): 'HTTPS://wwa1we.wbew.amazon-corp.wikaba.com:443'
[+] C2 Entry 1 (offset 0xed): 'HTTP://wwa1we.wbew.amazon-corp.wikaba.com:443'
..
VB 2022

SHA256: d011130defd8b988ab78043b30a9f7e0cada5751064b3975a19f4de92d2c0025

Multiple Protocol Listening at a Single
Port (Cont.)
$ ./c2fs.py -d -l corpus/query.txt -p 443 -f sp http Variant2
..
[*] malware options: family = ShadowPad; targeted protocol = http (version = Variant2)
[*] ShadowPad specific options: version = Variant2; key size = 2; key endian = big; header size = 0x8; header
type = 0x0; client session ID = 53978
[D] POST: http://137.220.185.203:443/ (proxy={}, stream=True, timeout=30)
[+] 137.220.185.203,active,client session ID matched (type=0x0)
..
$ ./c2fs.py -d -l corpus/query.txt -p 443 -f sp https Variant2
..
[*] malware options: family = ShadowPad; targeted protocol = https (version = Variant2)
[*] ShadowPad specific options: version = Variant2; key size = 2; key endian = big; header size = 0x8; header
type = 0x0; client session ID = 52256
[D] POST: https://137.220.185.203:443/ (proxy={}, stream=True, timeout=30)
[+] 137.220.185.203,active,client session ID matched (type=0x0)
VB 2022

Result: Population by Variant

Variant2
10%
Variant3
41%

Variant1
VB 2022

Variant1
49%

Variant3

Variant2

VB 2022

period

Au
g

-2
2

2

l-2

Ju

n22

ay
-2
2
Ju

M

2

22
-2

ar
-

number of active C2s
25

Ap
r

M

Fe
b22

Jan
-2
2

1

ec
-2

1

-2
1

ov
-2

D

N

O
ct

Se
p21

Result: Change in Number of Active C2s
System
issue

20

15

10

5

0

Samples Communicating with C2 IPs

Sample Malware
family

C2 IP address

Spyder
ReverseWindow
ShadowPad

156.240.104.149
43.129.188.223
213.59.118.124

VB 2022

C2
Sample
Protocol/Port
submission
used by sample
date on VT
TLS/443
2021/10/26
TCP/10333
2022/02/27
UDP/443
2022/03/20

C2 first-seen
date by
scanner
2021/10/16
2021/10/17
2022/03/06

C2 last-seen
date by
scanner
2021/10/16
2022/06/14
2022/06/13

Incident Response Case Triggered by
Discovered C2

VB 2022

Notes for
Internet-wide
C2 Scanning
VB 2022

How to Get Input (Port Scan) Data

scanning target ports
TCP/10333
TCP/55555
VB 2022

ZMap
4,940,037
3,199,856

Shodan
4
86

CenSys
1,306
486,497

Note: The data was
collected in 2021/11

Anonymization

Tor
Cost
Supported protocols
Risk of being blocked
VB 2022

Free
TCP
High

Commercial VPN
service
Non-free
TCP/UDP
Low

Anonymization (Cont.)
ZMap issue

VB 2022

Wrap-up

VB 2022

Wrap-up

VB 2022

Acknowledgement

VB 2022

Indicators of Compromise
Indicator

Type

Context

0a3279bb86ff0de24c2a4b646f24ffa196ee639cc23c64a
044e20f50b93bda21
03b7b511716c074e9f6ef37318638337fd7449897be99
9505d4a3219572829b4
aef610b66b9efd1fa916a38f8ffea8b988c20c5deebf4db8
3b6be63f7ada2cc0
d011130defd8b988ab78043b30a9f7e0cada5751064b3
975a19f4de92d2c0025
1ded9878f8680e1d91354cbb5ad8a6960efd6ddca2da1
57eb4c1ef0f0430fd5f
536def339fefa0c259cf34f809393322cdece06fc4f2b37f
06136375b073dff3

SHA256

Winnti 4.0 dat file

SHA256

ShadowPad Variant1

SHA256

ShadowPad Variant2

SHA256

ShadowPad Variant3

SHA256

9447b75af497e5a7f99f1ded1c1d87c53b5b59fce224a3
25932ad55eef9e0e4a

SHA256

Spyder communicating with the
ShadowPad C2 (156.240.104.149)
ReverseWindow communicating
with the ShadowPad C2
(43.129.188.223)
ShadowPad Variant1
communicating with the
ShadowPad C2 (213.59.118.124)

VB 2022

SHA256

Questions?

VB 2022