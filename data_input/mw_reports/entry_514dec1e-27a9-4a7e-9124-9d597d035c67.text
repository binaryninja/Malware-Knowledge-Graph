Analysis Report (TLP:WHITE)
Analysis of a PlugX variant (PlugX version 7.0)
Conducted by CIRCL - Computer Incident Response Center Luxembourg
Team CIRCL
March 29, 2013
Document version: 1.0

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

Contents
1 Scope of work

3

2 Analyzed samples
2.1 Limitations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
2.2 Sharing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

3
6
6

3 Executive summary

6

4 Analysis
4.1 Techniques used . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.2 Execution process . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.2.1 Diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.2.2 Explanation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.3 Implemented commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4 Command details . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.1 Option . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.2 Disk . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.3 Screen . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.4 Process . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.5 Service . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.6 Shell . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.7 Telnet . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.8 RegEdit . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.9 Nethood . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.10 Portmap . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.11 SQL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.12 Netstat . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.4.13 Keylogger . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.5 Other notable commands and functions . . . . . . . . . . . . . . . . . . . . . . .
4.5.1 log . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.6 Persistency . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.7 Control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.8 Network and domain information . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.8.1 Network . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.8.2 Domain . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.9 Current version and history of PlugX . . . . . . . . . . . . . . . . . . . . . . . . .

6
6
7
7
7
10
12
12
12
12
12
12
12
13
13
13
13
13
13
13
13
13
15
15
16
16
17
18

A Appendix
A.1 Indicators of Compromise (IOC) . . . . . . . . . . . . . . . . . . . . . . . . . . .
A.1.1 Pipes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
A.1.2 Files and directories . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
A.1.3 Registry . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
A.1.4 Network (hostname and destination IP addresses) . . . . . . . . . . . . .
A.2 References . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
A.3 VirusTotal results . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

18
18
18
18
19
19
19
20

Page 2 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

1

March 29, 2013

Scope of work

This report is the analysis of a Remote Access Tool (RAT) which we call a variant of Plugx1 .
Plugx is an interesting piece of malware for several reasons:
• It demonstrates the attack principle of the fastest/cheapest path of attack2 by abusing
perfectly valid signed binaries to perform the attack
• It features ways to defeat other protection mechanisms like UAC3
• In contrast to many other pieces of malware, the author4 shows the ability to write good
code, especially doing logging the right way to improve the piece of software
• It appears to be modularized and easily extensible

2

Analyzed samples
• Sample A - Stage 1 of Malware
– Description
* Hash found in a malware database
– Original ﬁlename
* update.exe
– Hashes
* MD5: f1f48360f95e1b43e9fba0fec5a2afb8
* SHA1: 70ceb467db7b0161d22e4545479f747417b9705a
* SHA-256: 2bc5ce39dd9afe2157448d3f6d8cb9c549ed39543d159616e38480b9e6c11c49
– Filetype
* PE32 executable (GUI) Intel 80386, for MS Windows, RAR self-extracting archive
– Filesize
* 370702 Bytes (326KB)
– Compile time
* Sat Jun 9 15:19:49 2012
• Sample B - Valid, signed McAfee binary
– Description
* File dropped by Sample A
– Original ﬁlename
* mcvsmap.exe
– Hashes
1 Known variant names: Gulpix, Korplug
2 http://satoss.uni.lu/seminars/srm/pdfs/2012-Alexandre-Dulaunoy.pdf
3 http://msdn.microsoft.com/en-us/library/windows/desktop/bb756996.aspx

4 For better readability we do not distinguish between a single author or a group of authors. Hence the
expression is a synonym for ”the authors”

Page 3 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

* MD5: 4e1e0b8b0673937415599bf2f24c44ad
* SHA1: 9224de3af2a246011c6294f64f27206d165317ba
* SHA-256: ae16e10e621d6610a3f7f2c7122f9d1263700ba02d1b90e42798decb2fe84096
– Filetype
* PE32 executable (GUI) Intel 80386, for MS Windows
– Filesize
* 262672 Bytes (257K)
– Compile time
* Fri May 8 17:59:52 2009
– Authenticode5 veriﬁcation
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19

V e r i f i e d : Signed
Signers :
McAfee , Inc .
VeriSign Class 3 Code Signing 2004 CA
Class 3 Public Primary C e r t i f i c a t i o n Authority
Signing date : 5 : 2 4 PM 5/8/2009
P u b l i s h e r : McAfee , Inc .
D e s c r i p t i o n : McAfee VirusMap Reporting module
Product : McAfee VirusScan API
Version : 1 3 , 1 1 , 0 , 0
F i l e v e r s i o n : 13 ,11 ,102 ,0
Strong Name: Unsigned
O r i g i n a l Name: McVsMap.EXE
I n t e r n a l Name: McVsMap
Copyright : Copyright � 2008 McAfee , Inc .
Comments : n/a
MD5: 4 e1e0b8b0673937415599bf2f24c44ad
SHA1: 9224 de3af2a246011c6294f64f27206d165317ba
SHA256 : ae16e10e621d6610a3f7f2c7122f9d1263700ba02d1b90e42798decb2fe84096

• Sample C - DLL to be loaded by Sample B, loads Sample D
– Description
* File dropped by Sample A
– Original ﬁlename
* McUtil.DLL
– Hashes
* MD5: ad4a646b38a482cc07d5b09b4ﬀfd3b3
* SHA1: ae0f9bf2740d00c5d485827eb32aca33feaa3a90
* SHA-256: 0a99238e1ebebc47d7a89b2ccddfae537479f7f77322b5d4941315d3f7e5ca48
– Filetype
* PE32 executable (DLL) (GUI) Intel 80386, for MS Windows
– Filesize
* 49152 Bytes (48K)
5 http://msdn.microsoft.com/en-us/library/ms537359%28v=vs.85%29.aspx

Page 4 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

– Compile time
* Wed Mar 13 02:52:28 2013
• Sample D - Malicious payload to be loaded by Sample C
– Description
* File dropped by Sample A
– Original ﬁlename
* McUtil.DLL.PPT
– Hashes
* MD5: 545bb4365a9b7cdb6d22844ebeedda93
* SHA1: a267f1183b4ﬀ843d68a63264846abf78cc71d1f
* SHA-256: d4fe890a08d4dd44b58a3b85b2a7e89536338099c1c42a9b7e85f4007b0a37b7
– Filetype
* pure code (IA32) without headers
– Filesize
* 124820 Bytes (122K)
– Compile time
* unknown (pure code)
• Sample E - Stage 2 of Malware
– Description
* Extracted malware from memory
– Original ﬁlename
* dump00C60000.bin
– Hashes
* MD5: 65ceb039e7b4731a165cfee081e220af
* SHA1: b49766187971e3070644a9de2054bc93241b2263
* SHA-256: deeac56026f3804968348c8afa5b7aba10900aeabee05751c0fcac2b88cﬀ71e
– Filetype
* PE32 executable (DLL) (GUI) Intel 80386, for MS Windows
– Filesize
* 176128 Bytes (172K)
– Compile time
* Mon Nov 26 04:46:01 2012
• Sample F - UAC circumvention
– Description
* File temporarily created on ﬁlesystem
– Original ﬁlename
Page 5 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

* UAC.TMP
– Hashes
* MD5: 52df5c2c07433e2a8f054c2347acb3b4
* SHA1: 8051474c1fc0d8f404a42ea32eca1699e54f02e1
* SHA-256: dc09091e5d0ce03c6144748f17bd636f2f0b2ca56f88b550c1d48860596dbdb1
– Filetype
* PE32 executable (DLL) (GUI) Intel 80386, for MS Windows
– Filesize
* 2560 Bytes (2.5K)
– Compile time
* Thu Mar 29 08:03:43 2012

2.1

Limitations

This work has been done with utmost care, following best practices in software reversing, forensic
investigations and/or information gathering. However, the work is only covering small aspects
(based on the indicators given, lacking full context) and not an exhaustive analysis, and hence
the report is as-is, not giving any guarantees of completeness or claiming absolute accuracy.
This work is provided for information only.

2.2

Sharing

The document is classiﬁed as TLP:WHITE, CIRCL authorizes everyone to share this analysis
report as-is without modiﬁcation.

3

Executive summary

The analyzed malicious software is an exhaustive Remote Access Tool (RAT) that defeats several
protection methods of modern Windows operating systems, including execution of signed code
and defeating UAC in Windows 7. It comes with a multitude of functionalities that are well
implemented.

4

Analysis

4.1

Techniques used

The analysis has been done using a mixed-approach of dynamic analysis and static analysis in
order to overcome some of the obfuscation and encryptions used by the malware. Some of the
techniques might have also an impact on the interpretation of the malware. Unfortunately, when
we started this investigation, the IP address is no longer accepting connections on the given ports
when tested on 2013-03-26. An interaction following the protocol of this malware is therefore no
longer possible.

Page 6 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

4.2

Execution process

4.2.1

Diagram
.

.drops

.

Sample B

l. oads
.into

. A
Sample

.drops

.

March 29, 2013

.drops

Sample C

l. oads
.into

.

Sample D

.execution

.

.decryption
Sample E
.W indows 7 : def eat U AC

.execution

.inject
.Legend

.
svchost.exe

.k ill

.inject

.

.
Sample F
.

.execution

Signed
code
Neutral
code

.
.
.
msiexec.exe

4.2.2

Malicious
code

Explanation

Sample A is a self-extracting archive which contains three ﬁles, Sample B, Sample C and Sample
D. It is assumed that Sample A is a part of another attack vector, like PDF or Oﬃce document
attacks where the user just opens a crafted document which exploits the document reader, drops
and opens both a readable document and a malicious ﬁle like Sample A.
1 Type = Rar
2 Solid = −

Page 7 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

3 Blocks = 3
4 Multivolume = −
5 Volumes = 1
6
7
Date
Time
Attr
Size
Compressed Name
8 −−−−−−−−−−−−−−−−−−− −−−−− −−−−−−−−−−−− −−−−−−−−−−−− −−−−−−−−−−−−−−−−−−−−−−−−
9 2009−05−14 0 0 : 5 6 : 1 2 . . . . A
262672
119784 mcvsmap . exe
10 2013−03−13 0 9 : 5 2 : 2 8 . . . . A
49152
20285 McUtil .DLL
11 2013−03−13 1 4 : 5 6 : 1 2 . . . . A
124820
124820 McUtil .DLL.PPT
12 −−−−−−−−−−−−−−−−−−− −−−−− −−−−−−−−−−−− −−−−−−−−−−−− −−−−−−−−−−−−−−−−−−−−−−−−
13
436644
264889 3 f i l e s , 0 f o l d e r s

Executing the self-extracting archive extracts the ﬁles and runs mcvsmap.exe (Sample B). Sample
B is a valid signed ﬁle that the author of the malware took from a software bundle from McAfee.
Sample B, when executed, attempts to load a ﬁle McUtil.DLL from the same directory, which
usually is another component of McAfee. The malware author instead bundled the valid McAfee
ﬁle Sample B with a custom DLL (Sample C). Since the ﬁle will be loaded without hesitation
(there are no protection mechanisms implemented; neither does McAfee check if the imported
ﬁle meets any conditions nor is any protection implemented for loading unsigned libraries in
signed code), the signed Sample B jumps into the beginning of the code section of Sample C (via
Push/Return):

At the target location the following code is executed:
1 read_execute_file ( )
2 {
3
NumberOfBytesRead = GetModuleFileNameW( hModule , &filename , 0x2000u ) ;
4
lstrcatW(&filename , L".PPT" ) ;
5
hFile_mcutil . d l l . ppt = CreateFileW(&filename , GENERIC_READ, 1u , 0 , OPEN_EXISTING, 0 ,
0) ;
6
if ( hFile_mcutil . d l l . ppt == −1 )
7
{
8
r e s u l t = GetLastError ( ) ;
9
}
10
else
11
{
12
b u f f e r = V i r t u a l A l l o c ( 0 , 0x100000u , MEM_COMMIT, PAGE_EXECUTE_READWRITE) ;
13
if ( b u f f e r && ReadFile ( hFile_mcutil . d l l . ppt , b u f f e r , 0x100000u , &NumberOfBytesRead
, 0) )
14
{
15
CloseHandle ( hFile_mcutil . d l l . ppt ) ;
16
buffer () ;
17
Sleep (0xFFFFFFFF) ;
18
Sleep (0xFFFFFFFF) ;
19
Sleep (0xFFFFFFFF) ;
20
result = 0;
21
}
22
else
23
{
24
r e s u l t = GetLastError ( ) ;

Page 8 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

25
}
26
}
27
return r e s u l t ;
28 }

The code retrieves the ﬁlename of itself (line 3), which is McUtil.DLL, and appends .PPT (line
4). A handle to the ﬁlename McUtil.DLL.PPT is created in line 5. In line 12 an exectuable
memory region is created, which is ﬁlled with the content of the ﬁle McUtil.DLL.PPT (line 13).
After closing the handle to the ﬁle (line 15), the memory region is called (line 16). The next
screenshot shows that the memory contains only pure code without any overhead like MZ/PE
headers. The entropy of this ﬁle is 7.997904 bits per byte:

The code, when executed, reveals the ﬁrst hint about what we found:

It decompresses and decrypts itself, using the Microsoft API call RtlDecompressBuﬀer and the
custom decryption routine:

Page 9 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

1 i n t crypt ( unsigned i n t a1 , i n t a2 , i n t a3 , i n t a4 )
2 {
3
if ( a4 > 0 )
4
{
5
v10 = a3 − a2 ;
6
do
7
{
8
a1 = a1 + ( a1 >> 3) − 0x11111111 ;
9
a1 = a1 + ( a1 >> 5) − 0x22222222 ;
10
a1 += 0x44444444 − ( a1 << 9) ;
11
a1 += 0x33333333 − ( a1 << 7) ;
12
v7 = *( v10 + a2++) ^ ( a1 + a1 + a1 + a1 ) ;
13
v8 = a4−− == 1 ;
14
*( a2 − 1) = v7 ;
15
}
16
while ( ! v8 ) ;
17
}
18
return 0 ;
19 }

The decrypted and decompressed ﬁle is not written onto disk, it always remains in memory.
Sample E is the extracted version of this memory segment. At this point it can be mentioned
that neither the encrypted Sample D nor the decrypted memory segment Sample E are detected
by Virus scanners.
After some initialisation work like adjusting tokens (SeDebugPrivilege, SeTcbPrivileg6 , to act as
part of the operating system), a new process is started, the original svchost.exe from Microsoft,
and the code from Sample E is injected into the memory of that process. In a next step,
svchost.exe is instructed to execute the original msiexec.exe from Microsoft, where also memory
is injected like it has been done for svchost.exe. Special conditions apply when run under Window
7, which is protected by User Account Control (UAC). UAC is supposed to protect the user better
from running malware by requesting the administator for approval before running a potentially
dangerous application. In the environment of Windows 7, the malware drops temporarily ﬁle
Sample F, which it uses to evade or defeat the UAC mechanism. After killing the parent processes,
only two processes are left: svchost and msiexec. Both are veriﬁed binaries, none of the includes
a malicious DLL.

Nevertheless, they both contain the malicious code. At this point in time the malware is already
talking to the C&C, no user interaction was required, all standard security mechanisms were
defeated.

4.3

Implemented commands

The analysis of Sample B revealed the commands as shown in the table below:

6 http://technet.microsoft.com/en-us/library/bb457125.aspx

Page 10 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

Source ﬁle

XPlugOption.cpp

XPlugDisk.cpp

XPlugScreen.cpp

XPlugProcess.cpp

XPlugService.cpp

XPlugShell.cpp
XPlugTelnet.cpp

XPlugRegedit.cpp

XPlugNethood.cpp
XPlugPortMap.cpp
XPlugSQL.cpp

XPlugNetstat.cpp
XPlugKeyLogger.cpp

Page 11 of 21

March 29, 2013

Table 1: Implemented commands
Internal command subcommand Description
0x2000
lock workstation
0x2001
shutdown workstation (forced)
Option
0x2002
reboot workstation
0x2003
shutdown workstation (graceful)
0x2005
show messagebox
0x3000
enumerate drives
0x3001
ﬁnd ﬁle
0x3002
ﬁnd ﬁle recursively
0x300A
create directory
Disk
0x3004
read ﬁle
0x3007
write ﬁle
0x300D
ﬁle copy/rename/delete/move
0x300C
create process on hidden desktop
0x300E
get expanded environment string
0x4000
Remote Desktop capabilities
0x4004
send mouse event
Screen
0x4005
send keyboard event
0x4006
send CTRL-Alt-Delete
0x4100
take screenshot
0x5000
create process
Process
0x5001
enumerate processes
0x5002
kill process
0x6000
query service conﬁg
0x6001
change service conﬁg (forced)
Service
0x6002
start service
0x6003
control service
0x6004
delete service
Shell
0x7002
start a cmd shell
Telnet
0x7100
start telnet server
0x9000
enumerate keys
0x9001
create key
0x9002
delete key
0x9003
copy key
RegEdit
0x9004
enumerate values
0x9005
set value
0x9006
delete value
0x9007
get value
Nethood
0xA000
enumerate network resources
Portmap
0xB000
starts port mapping
0xC000
get data source information
SQL
0xC001
get driver description
0xC002
execute statement
0xD000
get TCP table
Netstat
0xD001
get UDP table
0xD002
set TCP entry
Keylogger
0xE000
starts key logger thread

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

4.4

Command details

4.4.1

Option

March 29, 2013

XPlugOption implements commands to lock the workstation, shut it down or reboot it. In
addition, XPlugOption can create a thread that calls MessageBoxW() in order to present a
message box to the user.
4.4.2

Disk

XPlugDisk is used to enumerate connected disk drives and can be used to ﬁnd and manipulate
ﬁles and directories. In addition, XPlugDisk can be used to create a process, optionally on a
hidden Windows desktop with the name ”HH”, as the code below illustrates:
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15

if ( a1−>hidden )
{
hDesktop = CreateDesktopW (L"HH" , 0 , 0 , 0 , 0x10000000u , 0) ;
if ( ! hDesktop )
l o g ( "XPlugDisk.cpp" , 665 , 0) ;
}
hidden = a1−>hidden ;
S t a r t u p I n f o . lpDesktop = ( hidden != 0 ? L"HH" : 0) ;
S t a r t u p I n f o . cb = 6 8 ;
S t a r t u p I n f o . dwFlags = 1 ;
S t a r t u p I n f o . wShowWindow = hidden == 0 ;
if ( CreateProcessW ( 0 , &a1−>commandline , 0 , 0 , 0 , 0 , 0 , 0 , &StartupInfo , &
ProcessInformation ) )
{
...
}

4.4.3

Screen

XPlugScreen is not only taking screenshots, it is also implementing remote desktop capabilities.
It is able to capture the screen (internal command: ScreenT1) and can send mouse and keyboard
events (internal command: ScreenT2).
4.4.4

Process

XPlugProcess implements three commands and is able to enumerate, create and kill processes.
4.4.5

Service

In the module XPlugService commands are available related to Windows services. Code is
implemented to query service conﬁgurations, change service conﬁguration, start, control and
delete services.
4.4.6

Shell

A remote shell for the attacker is created in the module XPlugShell, by creating an asynchronous
set of pipes (\pipe\a and \pipe\b) for cmd.exe and the console attached to it (AttachConsole()).

Page 12 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

4.4.7

March 29, 2013

Telnet

cmd.exe /Q is executed in the module XPlugTelnet in order to start a telnet server on the
attacked machine.
4.4.8

RegEdit

XPlugRegedit implements a set of commands to process the Windows registry. It is able to
enumerate, create, delete and copy keys. It is also able to enumerate, set, delete and get values
from the registry.
4.4.9

Nethood

XPlugNethood is the module to enumerate network resources like network shares.
4.4.10

Portmap

XPlugPortMap indicates that it performs some port mapping, however, the code is not understood, yet.
4.4.11

SQL

XPlugSQL implements three functions to query SQL servers: a function to get data source
information, a function to get the driver description and a function to execute SQL statements.
4.4.12

Netstat

XPlugNetstat gets the TCP and UDP connection table and is able to set TCP table entries.
4.4.13

Keylogger

The keylogger implemented in XPlugKeyLogger catches Window titles, date, time and logs
entered keys into the ﬁle
1 C: \ Documents and S e t t i n g s \ A l l Users \VirusMap\NvSmart . hlp

It has the format following the example below:
1 2013−03−26 0 9 : 4 0 : 5 7 | C: \ Program F i l e s \ M o z i l l a F i r e f o x \ f i r e f o x . exe − M o z i l l a F i r e f o x
2 www. g o o g l e . com
3
4 2013−03−26 0 9 : 4 7 : 4 9 | C: \WINDOWS\system32\notepad . exe | U n t i t l e d − Notepad
5 This i s not a password
6
7 2013−03−26 0 9 : 4 8 : 0 6 | C: \WINDOWS\ Explorer .EXE | C: \ Documents and S e t t i n g s \ A l l Users \
VirusMap

4.5

Other notable commands and functions

4.5.1

log

This function is called almost everywhere when the author expects that a functions returns an
error, at 1036 places. This is obviously done to ensure code quality.

Page 13 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

1 write_log (LPCWSTR l p B u f f e r )
2 {
3
ExpandEnvironmentStringsW (L"%ALLUSERSPROFILE%" , &path_to_bug . log , 0x800u ) ;
4
// %ALLUSERSPROFILE%\SxS\bug . l o g
5
lstrcatW(&path_to_bug . log , L"\\SxS" ) ;
6
CreateDirectoryW(&path_to_bug . log , 0) ;
7
SetFileAttributesW(&path_to_bug . log , 6u) ;
8
lstrcatW(&path_to_bug . log , L"\\bug.log" ) ;
9
r e s u l t = CreateFileW(&path_to_bug . log , 0x40000000u , 1u , 0 , 4u , 2u , 0) ;
10
if ( r e s u l t != −1 )
11
{
12
if ( S e t F i l e P o i n t e r ( r e s u l t , 0 , 0 , 2u) != −1 )
13
{
14
GetLocalTime(&SystemTime ) ;
15
NumberOfBytesWritten = wsprintfW (
16
&Buffer ,
17
L"%4.4d -%2.2d -%2.2d %2.2d:%2.2d:%2.2d: " ,
18
SystemTime . wYear ,
19
SystemTime . wMonth,
20
SystemTime . wDay,
21
SystemTime . wHour ,
22
SystemTime . wMinute ,
23
SystemTime . wSecond ) ;
24
if ( WriteFile ( r e s u l t , &Buffer , 2 * NumberOfBytesWritten , &NumberOfBytesWritten ,
0) )
25
{
26
l e n = lstrlenW ( l p B u f f e r ) ;
27
WriteFile ( r e s u l t , l p B u f f e r , 2 * len , &len , 0) ;
28
}
29
}
30
r e s u l t = CloseHandle ( r e s u l t ) ;
31
}
32
return r e s u l t ;
33 }

Example log ﬁle entries from ﬁle
1 %ALLUSERSPROFILE%\SxS\bug . l o g
1 2013−03−25 1 1 : 4 3 : 2 8 : f i l e : XSetting . h , l i n e : 57 , e r r o r : [ 1 3 0 0 ] Not a l l p r i v i l e g e s
r e f e r e n c e d are a s s i g n e d to the c a l l e r .
2 2013−03−25 1 1 : 5 1 : 1 2 : f i l e : XInstallUAC . cpp , l i n e : 162 , e r r o r : [ 5 ] Access i s denied .
3 2013−03−25 1 3 : 5 9 : 4 5 : f i l e : XRTL. cpp , l i n e : 186 , e r r o r : [ 1 3 0 0 ] Not a l l p r i v i l e g e s
r e f e r e n c e d are a s s i g n e d to the c a l l e r .
4 2013−03−25 1 4 : 0 7 : 1 2 : f i l e : XRTL. cpp , l i n e : 186 , e r r o r : [ 1 2 3 ] The filename , d i r e c t o r y
name , or volume l a b e l syntax i s i n c o r r e c t .
5 2013−03−25 1 4 : 0 7 : 1 2 : f i l e : XSetting . h , l i n e : 58 , e r r o r : [ 3 ] The system cannot f i n d the
path s p e c i f i e d .
6 2013−03−25 1 4 : 2 1 : 1 2 : f i l e : dllmain . cpp , l i n e : 47 , e r r o r : [ 1 3 0 0 ] Not a l l p r i v i l e g e s
r e f e r e n c e d are a s s i g n e d to the c a l l e r .
7 2013−03−25 1 7 : 3 1 : 5 8 : f i l e : X I n s t a l l . cpp , l i n e : 451 , e r r o r : [ 5 ] Access i s denied .
8 2013−03−25 1 7 : 3 7 : 0 0 : f i l e : XSoTcpHttp . cpp , l i n e : 646 , e r r o r : [ 1 2 0 2 9 ] *

In addition an exception ﬁlter is installed to fetch the circumstances of otherwise not caught
errors:
1 TopLevelExceptionFilter ( struct_a1_30 *a1 )
2 {
3 ...
4
if ( wsprintfA (
5
&OutputString ,

Page 14 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

6

"EName :%s,EAddr :0x%p,ECode :0x%p,EAX:%p,EBX:%p,ECX:%p,EDX:%p,ESI:%p,EDI:%p,EBP
:%p,ESP:%p,EIP:%p\r\n" ,
7
&String1 ,
8
a1−>ECode [ 3 ] ,
9
*a1−>ECode ,
10
v6−>reg_eax ,
11
v6−>reg_ebx ,
12
v6−>reg_ecx ,
13
v6−>reg_edx ,
14
v6−>reg_esi ,
15
v6−>reg_edi ,
16
v6−>reg_ebp ,
17
v6−>reg_esp ,
18
v6−>reg_eip ) >= 256 )
19
l o g ( "XException.cpp" , 39 , 0) ;
20
ca ll_wr it e_l og(&OutputString ) ;
21
call_OutputDebugStringA(&OutputString ) ;
22 . . .
23 }

4.6

Persistency

The three ﬁles Sample B, C and D are copied into the directory
1 C: \ Documents and S e t t i n g s \ A l l Users \VirusMap

respectively in
1 C: \ ProgramData\VirusMap (C: \ Users \ A l l Users \VirusMap )

After that, a new registry entry is set:
1 HKEY_CURRENT_USER\ Software \ M i c r o s o f t \Windows\ CurrentVersion \Run

which calls mcvsmap.exe (Sample B) after login.
Another option is the installation as a service in
1 HKEY_LOCAL_MACHINE\SYSTEM\ ControlSet001 \ S e r v i c e s \VirusMap

The key ”Imagepath” calls the same binary mcvsmap.exe (Sample B).

4.7

Control

The attacked computer uses TCP and UDP to connect to port 443 on help.yahoo-upgrade.com
(122.199.194.197). Unfortunately, the machine at that IP address doesn’t seem to reply to our
requests anymore on 2013-03-26.
The Passive DNS showed some other associated domains and hostnames with this IP address:
1
2
3
4
5

help . yahoo−upgrade . com
support . yahoo−upgrade . com
update . ayuisyahooapis . com
support . ayuisyahooapis . com
update . t r e n d m i c r o s o f t . co . i n

It’s highly probable that theses hostnames were also used for other campaigns. You might use
these as additional indicators for the detection of potential infections.

Page 15 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

4.8

Network and domain information

4.8.1

Network

March 29, 2013

The IP address is located in the ASN 17877 and the ISP is not a known bulletproof hoster as
you can see on its historical7 BGP ranking evolution.

1 inetnum :
2 netname :
3 descr :
4 descr :
5 descr :
6 descr :
7 descr :
8 descr :
9 descr :
10 d e s c r :
11 d e s c r :
12 country :
13 admin−c :
14 tech−c :
15 remarks :
16 s t a t u s :
17 mnt−by :
18 mnt−lower :
19 changed :
20 source :
21
22 person :
23 nic−hdl :
24 e−mail :
25 address :
26 phone :
27 fax−no :
28 country :
29 changed :

122.199.128.0 − 122.199.255.255
VAAN
NexG
5F SeoulAcademy B/D, 967−6 Daechi−Dong , Gangnam−Gu, 135−280
************************************************
All o c at ed to KRNIC Member .
I f you would l i k e to f i n d assignment
i nform ation i n d e t a i l p l e a s e r e f e r to
the KRNIC Whois Database at :
"http :// whois.nic.or.kr/english/index.html"
************************************************
KR
SL1625−AP
SL1625−AP
www. nexg . net
ALLOCATED PORTABLE
MNT−KRNIC−AP
MNT−KRNIC−AP
hm−changed@apnic . net 20060606
APNIC
Sanguk Lee
SL1625−AP
ip@nexg . net
5F SeoulAcademy B/D, 967−6 Daechi−Dong , Gangnam−Gu, 135−280
+82−2−538−7060
+82−2−571−8998
KR
hostmaster@nida . or . kr 20050105

7 http://bgpranking.circl.lu/asn_details?asn=17877

Page 16 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

30 mnt−by :
31 source :
32
33 inetnum :
34 netname :
35 d e s c r :
36 country :
37 admin−c :
38 tech−c :
39 s t a t u s :
40 mnt−by :
41 mnt−i r t :
42 remarks :
43 remarks :
44 remarks :
45 changed :
46 source :

4.8.2

March 29, 2013

MNT−KRNIC−AP
APNIC
122.199.128.0 − 122.199.255.255
VAAN−KR
NexG
KR
LS151−KR
LS151−KR
ALLOCATED PORTABLE
MNT−KRNIC−AP
IRT−KRNIC−KR
This i nformation has been p a r t i a l l y mirrored by APNIC from
KRNIC. To obtain more s p e c i f i c information , p l e a s e use the
KRNIC whois s e r v e r at whois . k r n i c . net .
hostmaster@nic . or . kr
KRNIC

Domain

1
Domain Name: YAHOO−UPGRADE.COM
2
R e g i s t r a r : JIANGSU BANGNING SCIENCE & TECHNOLOGY CO. LTD
3
Whois Server : whois . 5 5 h l . com
4
R e f e r r a l URL: http : / /www. 5 5 h l . com
5
Name Server : DNS5. 4CUN.COM
6
Name Server : DNS6. 4CUN.COM
7
Status : ok
8
Updated Date : 08−aug−2012
9
Creation Date : 18− j u l −2011
10
Expiration Date : 18−j u l −2013
11
12 >>> Last update o f whois database : Wed, 27 Mar 2013 2 2 : 3 6 : 1 3 UTC <<<
13
14 Domain Name: yahoo−upgrade . com
15
16 R e g i s t r a n t Contact :
17 yahoo
18 yahoo yahoo whiteyoo_123@yahoo . com
19 telephone : +48.56756756756
20 fax : +48.56732453453
21 yahoo yahoo yahoo 345345
22 CA
23
24 Administrative Contact :
25 yahoo yahoo whiteyoo_123@yahoo . com
26 telephone : +48.56756756756
27 fax : +48.56732453453
28 yahoo yahoo yahoo 345345
29 CA
30
31 Technical Contact :
32 yahoo yahoo whiteyoo_123@yahoo . com
33 telephone : +48.56756756756
34 fax : +48.56732453453
35 yahoo yahoo yahoo 345345
36 CA
37
38 B i l l i n g Contact :
39 yahoo yahoo whiteyoo_123@yahoo . com
40 telephone : +48.56756756756

Page 17 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

41 fax : +48.56732453453
42 yahoo yahoo yahoo 345345
43 CA

4.9

Current version and history of PlugX

A version string can be found in this binary:
1 d : \ work\ plug7 . 0 ( mcvsmap) ( f k i n g )ǰ ( ) \ s h e l l c o d e \ s h e l l c o d e \XPlug . h

This could mean PlugX, version 7.0 codename fking, build for mcvsmap. References can be
found on the internet for previous versions of this malware family:
1 d : \ work\ plug4 . 0 ( nvsmart ) ( s x l ) \ s h e l l c o d e \ s h e l l c o d e \XPlug . h
2 d : \ work\ plug3 . 1 ( icesword ) \ s h e l l c o d e \ s h e l l c o d e \XPlug . h
3 d : \ work\Plug3 . 0 ( Gf )UDP\ S h e l l 6 \ Release \ S h e l l 6 . pdb
4 i : \ work\ plug2 . 0 ( ) \ s h e l l c o d e \ s h e l l c o d e \XPlug . h

A

Appendix

A.1

Indicators of Compromise (IOC)

This section summarizes the known indicators of compromise. The list might not be exhaustive,
but the existence of any or all of the following indicators might help to discover an infection.
A.1.1
1
2
3

Pipes

\PIPE\a$PID
\PIPE\b$PID
\PIPE\RUN_AS_USER($PID)

(where $PID is the process ID of the active malicious process)
A.1.2

Files and directories

• Static ﬁles (dropped ﬁles)
– update.exe
1 MD5:
2 SHA1:
3 SHA−256:

f1f48360f95e1b43e9fba0fec5a2afb8
70 ceb467db7b0161d22e4545479f747417b9705a
2 bc5ce39dd9afe2157448d3f6d8cb9c549ed39543d159616e38480b9e6c11c49

– mcvsmap.exe
1 MD5:
2 SHA1:
3 SHA−256:

4 e1e0b8b0673937415599bf2f24c44ad
9224 de3af2a246011c6294f64f27206d165317ba
ae16e10e621d6610a3f7f2c7122f9d1263700ba02d1b90e42798decb2fe84096

– McUtil.DLL
1 MD5:
2 SHA1:
3 SHA−256:

Page 18 of 21

ad4a646b38a482cc07d5b09b4fffd3b3
ae0f9bf2740d00c5d485827eb32aca33feaa3a90
0 a99238e1ebebc47d7a89b2ccddfae537479f7f77322b5d4941315d3f7e5ca48

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

– McUtil.DLL.PPT
1 MD5:
2 SHA1:
3 SHA−256:

545 bb4365a9b7cdb6d22844ebeedda93
a267f1183b4ff843d68a63264846abf78cc71d1f
d4fe890a08d4dd44b58a3b85b2a7e89536338099c1c42a9b7e85f4007b0a37b7

– UAC.TMP
1 MD5:
2 SHA1:
3 SHA−256:

52 df5c2c07433e2a8f054c2347acb3b4
8051474 c1fc0d8f404a42ea32eca1699e54f02e1
dc09091e5d0ce03c6144748f17bd636f2f0b2ca56f88b550c1d48860596dbdb1

Files and/or directories might be hidden and carry the system ﬂag
1 C: \ ProgramData\VirusMap (Windows 7)
2 C: \ Users \ A l l Users \VirusMap (Windows 7)
3 C: \ Documents and S e t t i n g s \ A l l Users \VirusMap (Windows XP)
4 %ALLUSERSPROFILE%\SxS\bug . l o g
5 C: \ Documents and S e t t i n g s \ A l l Users \VirusMap\NvSmart . hlp

A.1.3

Registry

1 HKEY_LOCAL_MACHINE\SYSTEM\ ControlSet001 \ S e r v i c e s \VirusMap and a key r e f e r e n c i n g Sample
B
2 HKEY_CURRENT_USER\ Software \ M i c r o s o f t \Windows\ CurrentVersion \Run and a key r e f e r e n c i n g
Sample B

A.1.4

Network (hostname and destination IP addresses)

1 help . yahoo−upgrade . com
2 122.199.194.197

A.2

References

• WHITE PAPER: PLUG X - PAYLOAD EXTRACTION
– http://www.contextis.com/files/PlugX_-_Payload_Extraction_March_2013_1.
pdf
– Context Information Security - http://www.contextis.com/
– Published 2013-03-22
• An Analysis of PlugX
– http://lastline.com/blog.php
– Lastline - http://www.lastline.com/
– no publication date found
• PlugX is becoming mature
– http://www.securelist.com/en/blog/208193974/PlugX_is_becoming_mature
– Kaspersky Lab - http://www.kaspersky.com/
Page 19 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

– Published 2012-11-27
• Unplugging PlugX Capabilities

– http://blog.trendmicro.com/trendlabs-security-intelligence/unplugging-plugx-capabilities
– TrendMicro - http://www.trendmicro.eu/
– Published 2012-09-17
• Tracking down the author of the PlugX RAT

– http://labs.alienvault.com/labs/index.php/2012/tracking-down-the-author-of-the-plugx-rat
– AlienVault - http://labs.alienvault.com
– Published 2012-09-13

A.3

VirusTotal results

• Sample A
1 MicroWorld−eScan :
Trojan . Agent .AZDK
2 nProtect :
Trojan . Agent .AZDK
3 McAfee :
RDN/ Generic BackDoor ! gq
4 Malwarebytes :
Trojan . Dropper .CH
5 Symantec :
WS. Reputation . 1
6 Norman :
Agent . APIJH
7 TrendMicro−HouseCall : BKDR_POISON.PQ
8 Avast :
Win32 : Gulpix−B [ Trj ]
9 Kaspersky :
Backdoor . Win32 . Gulpix . bo
10 BitDefender :
Trojan . Agent .AZDK
11 Agnitum :
Backdoor . Gulpix ! EFaRR6zLtc4
12 ViRobot :
Backdoor . Win32 .A. Gulpix . 3 7 0 7 0 2 .B
13 Comodo :
UnclassifiedMalware
14 F−Secure :
Trojan . Agent .AZDK
15 DrWeb:
Trojan . Click2 .52215
16 VIPRE:
Trojan . Win32 . Generic !BT
17 AntiVir :
TR/Agent . azdk . 3
18 TrendMicro :
BKDR_POISON.PQ
19 McAfee−GW−Edition :
RDN/ Generic BackDoor ! gq
20 Sophos :
Troj /Agent−AATT
21 Kingsoft :
Win32 . Hack . Gulpix . ( kcloud )
22 M i c r o s o f t :
Backdoor : Win32/Plugx .A
23 GData :
Trojan . Agent .AZDK
24 AhnLab−V3 :
Backdoor/Win32 . Gulpix
25 I karu s :
Backdoor . Win32 . Gulpix
26 F o r t i n e t :
W32/Gulpix .BO! t r . bdr
27 AVG:
Agent4 .AKAP
28 Panda :
Trj /CI .A
29 Scanned : 2013−03−21 0 4 : 0 1 : 1 2 − 45 scans − 28 d e t e c t i o n s (62.0%)

• Sample B (mcvsmap.exe)
1 Scanned : 2013−03−21 1 3 : 2 9 : 4 5 − 44 scans − 0 d e t e c t i o n s (0.0%)

• Sample C (McUtil.DLL)

Page 20 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu

CIRCL - Computer Incident Response Center Luxembourg

March 29, 2013

1 MicroWorld−eScan :
Trojan . Agent .AZDK
2 nProtect :
Trojan . Agent .AZDK
3 McAfee :
RDN/ Generic BackDoor ! gt
4 Malwarebytes :
Backdoor . Gulpix
5 Symantec :
WS. Reputation . 1
6 Norman :
Agent . APIJH
7 TrendMicro−HouseCall : TROJ_GEN.RCBCRCJ
8 Avast :
Win32 : Gulpix−B [ Trj ]
9 Kaspersky :
Backdoor . Win32 . Gulpix . bo
10 BitDefender :
Trojan . Agent .AZDK
11 Agnitum :
Backdoor . Gulpix ! EFaRR6zLtc4
12 Comodo :
UnclassifiedMalware
13 F−Secure :
Trojan . Agent .AZDK
14 DrWeb:
Trojan . Click2 .52215
15 VIPRE:
Trojan . Win32 . Generic !BT
16 AntiVir :
TR/Agent . azdk . 2
17 TrendMicro :
TROJ_GEN.RCBCRCJ
18 McAfee−GW−Edition :
RDN/ Generic BackDoor ! gt
19 Sophos :
Troj /Agent−AATT
20 M i c r o s o f t :
Backdoor : Win32/Plugx .A
21 GData :
Trojan . Agent .AZDK
22 Commtouch :
W32/Backdoor . IYCB−5867
23 I karu s :
Backdoor . Win32 . Gulpix
24 F o r t i n e t :
W32/Gulpix .BO! t r . bdr
25 AVG:
Agent4 .AKAP
26 Panda :
Trj /CI .A
27 Scanned : 2013−03−21 1 3 : 4 6 : 1 0 − 44 scans − 26 d e t e c t i o n s (59.0%)

• Sample D (McUtil.DLL.PPT)
1 Not uploaded to VirusTotal .

• Sample E
1 Not uploaded to VirusTotal .

• Sample F (UAC.TMP)
1 Panda :
Suspicious f i l e
2 Scanned : 2012−09−20 0 2 : 3 3 : 5 5 − 43 scans − 1 d e t e c t i o n s (2.0%)

Page 21 of 21

CIRCL - Computer Incident Response Center Luxembourg
c/o smile - ”security made in Lëtzebuerg” GIE
41, avenue de la gare, L-1611 Luxembourg
(+352) 247 88444 - info@circl.lu – www.circl.lu